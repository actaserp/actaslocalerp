<html layout:decorate="~{layout_page}">
<head>
    <style>
        .radio-wrap {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .radio-wrap input[type="radio"] {
            appearance: none;
            -webkit-appearance: none; /* 사파리용 */
            width: 16px;
            height: 16px;

            border-radius: 50%;
            position: relative;
            cursor: pointer;
        }

        .radio-wrap input[type="radio"]::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 8px;
            height: 8px;
            background-color: #666;
            border-radius: 50%;
            opacity: 0;
            transition: 0.2s;
        }

        .radio-wrap input[type="radio"]:checked::after {
            opacity: 1;
        }
    </style>
</head>
<th:block layout:fragment="content">
    <div class="layout-contents">
        <div class="tab-wrap">
            <ul class="tab-links">
                <li>
                    <a href="#tab1" title="요청등록" id="listTabLink">요청등록</a>
                </li>
                <li>
                    <a href="#tab2" title="요청현황" id="inputTabLink">요청현황</a>
                </li>
            </ul>
            <div class="tab-contents">
                <section class="tab-item" id="tab1">
                    <div class="section-top">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    <label>
                                        요청일자<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="date" id="searchDate" name="searchDate"  />
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        사업자번호<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="text" placeholder="해당 칸을 클릭해주세요"  id="spNum" name="spNum" readonly/>
                                        <input type="hidden"  id="cboCompanyHidden" name="cboCompanyHidden"  />
                                    </div>
                                </dd>
                            </dl>

                            <dl>
                                <dt>
                                    <label>
                                        요청자
                                    </label>
                                </dt>
                                <dd>
                                    <input type="text" class="form-control2" id="reqPer" name="reqPer" />
                                </dd>
                            </dl>

                            <dl>
                                <dt>
                                    <label>
                                        연락처<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <input type="text" class="form-control2" id="telNum" name="telNum" />
                                </dd>
                            </dl>
                            <dl>
                                <dd>
                                    <li>
                                        <a class="btn btn-delete" title="검색" id="btnClear">
                                            <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                            <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                            신규
                                        </a>
                                        <a class="btn btn-delete" title="검색" id="btnSave">
                                            <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                            <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                            저장
                                        </a>
                                    </li>
                                </dd>
                            </dl>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <dl style="width: 32%">
                                <dt>
                                    <label>
                                        제목<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <input type="text" class="form-control2" id="title" name="title" style="width:100%"/>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        요청구분<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <select type="text" class="form-control2" id="reqType" name="reqType" >
                                    </select>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        화면명<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <input type="text" class="form-control2" id="scrNum" name="scrNum" />
                                </dd>
                            </dl>
                        </div>
                    </div>
                    <div class="" id="reqText">
                        <div class="webEdit" id="webEdit"></div>
                    </div>
                    <div class="" id="" style="display: flex; gap: 10px;">
                        <input type="text" id="fileText" placeholder="파일 찾기">
                        <input type="file" id="drawingFile" accept="application" style="display:none;" />
                        <button type="button" class="btn-excellt" id="btnFile" name="btnFile"
                                style="width: 100px; height: 36px;">
                            파일선택
                        </button>
                    </div>
                </section>
<!--                요청현황 탭-->
                <section class="tab-item" id="tab2">
                    <div class="section-top">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    <label>
                                        조회일자<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="date" id="searchfrdate2" name="searchfrdate2"  />
                                        <span class="slow_sign">~</span>
                                        <input type="date" id="searchtodate2" name="searchtodate2" />
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        업체명<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="text" placeholder=""  id="cboCompany2" name="cboCompany2" readonly/>
                                        <input type="hidden"  id="cboCompanyHidden2" name="cboCompanyHidden2"  />
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        요청구분<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <select id="reqType"></select>
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>&nbsp;</dt>
                                <dd>
                                    <li>
                                        <a class="btn btn-delete" title="검색" id="btnSearch2">
                                            <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                            <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                            검색
                                        </a>
                                    </li>
                                </dd>
                            </dl>

                        </div>
                    </div>
                    <div id="theGrid_saleList2" style="height: 730px;"></div>
                </section>
            </div>
        </div>


    </div>
</th:block>

<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting" ></th:block>
    <th:block th:replace="/common/popup_account :: popup_account" />
    <th:block th:replace="/common/popup_company :: popup_company"></th:block>
    <th:block th:replace="/shipment/trade_stmt/trade_stmt_tmpl :: printTemplate"></th:block>
    <!-- Toast UI Editor CSS -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />

    <!-- Toast UI Editor JS -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

    <script type="text/javascript">


        let sales_type = [];
        let LoadingFlag = false;
        let editor;
        class SalesList {
            constructor() {
                this.grid1 = null;
                this.grid2 = null;
                this.url = '/api/request';


                this.viewData = new wijmo.collections.CollectionView();
                this.viewData2 = new wijmo.collections.CollectionView();


                $('#searchfrdate, #searchfrdate2').val(getNowDateMinus7());
                $('#searchtodate, #searchtodate2').val(getNowDate());
                sales_type = AjaxUtil.fillSelectOptions($('#sale_type'), 'system_code', 'choose', false, 'sale_type');
                selectBoxBinding('sale_type2', sales_type);

                this.init();
            }

            init() {
                let _this = this;

                const cv = _this.viewData

                cv.groupDescriptions.push(new wijmo.collections.PropertyGroupDescription('misdate', function (item, prop) {
                    return item[prop].substring(0, 7); // '2025-04'
                }));

                // 3. FlexGrid 생성
                // this.grid1 = new wijmo.grid.FlexGrid('#theGrid_saleList', {
                //     autoGenerateColumns: false,
                //     showMarquee: true,
                //     allowSorting: 'MultiColumn',
                //     selectionMode: wijmo.grid.SelectionMode.Row,
                //     isReadOnly: true,
                //     groupHeaderFormat: '{value}월 매출 - 총 {count}건',
                //     columns: [
                //         { binding: 'misdate', header: '매출일자', align: 'center', width: 150 },
                //         { binding: 'misgubun', header: '매출구분', align: 'center', width: 120 },
                //         { binding: 'companycode', header: '거래처코드', align: 'left', width: 120},
                //         { binding: 'companyname', header: '거래처명', align: 'left', width: '*' },
                //         { binding: 'itemnm', header: '품명', align: 'left', width: 150 },
                //         { binding: 'spec', header: '규격', align: 'center', width: 150 },
                //         { binding: 'supplycost', header: '공급가', align: 'right', width: 120, aggregate: 'Sum' },
                //         { binding: 'taxtotal', header: '부가세', align: 'right', width: 120, aggregate: 'Sum' },
                //         { binding: 'totalamt', header: '합계', align: 'right', width: 120, aggregate: 'Sum' },
                //     ],
                //     itemsSource: cv,
                //
                // });
                // this.grid1.rowHeaders.columns.splice(0, 1);
                // new FlexGridContextMenu(this.grid1);
                // this.grid1.downloadFileName = '매출현황_상세현황';
                //
                // this.grid1.allowMerging = wijmo.grid.AllowMerging.All;
                // this.grid1.columns[0].allowMerging = true;
                // this.grid1.columns[1].allowMerging = true;
                //
                //
                //
                //
                // this.grid2 = new wijmo.grid.FlexGrid('#theGrid_saleList2', {
                //     autoGenerateColumns: false,
                //     showMarquee: true,
                //     allowSorting: 'MultiColumn',
                //     selectionMode: wijmo.grid.SelectionMode.Row,
                //     isReadOnly: true,
                //     itemsSource: _this.viewData2,
                //     columns: [
                //         { binding: 'ivercorpnum', header: '사업자등록번호', align: 'center', width: '*' },
                //         { binding: 'ivercorpnm', header: '상호', align: 'left', width: '*'},
                //         { binding: 'cnt', header: '매수', align: 'right', width: '*', aggregate: 'Sum' },
                //         { binding: 'supplycost', header: '공급가액', align: 'right', width: '*', aggregate: 'Sum' },
                //         { binding: 'taxtotal', header: '세액', align: 'right', width: 150, aggregate: 'Sum' },
                //     ]
                // });
                //
                // this.grid2.rowHeaders.columns.splice(0, 1);
                // new FlexGridContextMenu(this.grid2);
                // this.grid2.downloadFileName = '매출현황_집계현황';
                //
                // // 1. footer에 GroupRow 추가
                // this.grid2.columnFooters.rows.push(new wijmo.grid.GroupRow());
                //
                // // 2. trade_date 컬럼 인덱스 찾기
                // const tradeDateColIndex = this.grid2.columns.findIndex(c => c.binding === 'ivercorpnum');
                //
                // // 3. 푸터에 'Σ' 찍기
                // this.grid2.columnFooters.setCellData(0, tradeDateColIndex, '합계');

            }


            searchMain(){
                // let _this = this;
                //
                // let data = {
                //     searchfrdate: $('#searchfrdate').val(),
                //     searchtodate: $('#searchtodate').val(),
                //     cltcd: $('#cboCompany').val().trim() === '' ? '' : $('#cboCompanyHidden').val(),
                //     sale_type: $('#sale_type').val(),
                //     taxtype: $('input[name=taxtype]:checked').val(),
                //     spjangcd: getSpjangcdFromSession(),
                // }
                //
                // let result = AjaxUtil.getSyncData(_this.url + '/search', data);
                // console.log()
                // if(result != null){
                //     _this.viewData.sourceCollection = result.data;
                // }
            }

            searchMain2(type){
                // let _this = this;
                //
                // if(type==='load' && LoadingFlag) return;
                //
                // let data = {
                //     searchfrdate2: $('#searchfrdate2').val(),
                //     searchtodate2: $('#searchtodate2').val(),
                //     cltcd2: $('#cboCompany2').val().trim() === '' ? '' : $('#cboCompanyHidden2').val(),
                //     sale_type2: $('#sale_type2').val(),
                //     taxtype2: $('input[name=taxtype2]:checked').val(),
                //     spjangcd: getSpjangcdFromSession(),
                // }
                //
                // let result = AjaxUtil.getSyncData(_this.url + '/search2', data);
                //
                // if(result != null) {
                //     _this.viewData2.sourceCollection = result.data;
                //     //_this.bindingStatisticsField(result.data['Statistics']);
                //     LoadingFlag = true; //서브탭 클릭할때마다 서치 방지
                // }

            }

        }

        let page = null;


        $(document).ready(function (e) {
            page = new SalesList();

            $('#cboCompany').click(function(){
                companyPopupOpen('cboCompany', 'cboCompanyHidden');
            });
            $('#cboCompany2').click(function(){
                companyPopupOpen('cboCompany2', 'cboCompanyHidden2');
            });

            $('#btnSearch').click(function(){
                page.searchMain();
            });

            $('#btnSearch2').click(function(){
                page.searchMain2();
            });

            $('#inputTabLink').click(function (){
                page.searchMain2('load');
            })

            // 파일선택 버튼 클릭 시, 파일 선택창 실행
            $(document).on('click', '#btnFile, #fileText', function() {
                $('#drawingFile').click(); // ✅ 이 한 줄이 핵심
            });

            // ✅ Toast UI Editor 생성
            editor = new toastui.Editor({
                el: document.querySelector('#webEdit'),  // 에디터 붙일 요소
                height: '500px',                         // 높이
                initialEditType: 'wysiwyg',              // 'markdown' 도 가능
                previewStyle: 'vertical',                // 미리보기 스타일
                initialValue: '',                        // 초기 내용
                placeholder: '요청 내용을 입력하세요...',
                toolbarItems: [                             // 툴바 설정
                    ['heading', 'bold', 'italic', 'strike'],
                    ['hr', 'quote'],
                    ['ul', 'ol', 'task', 'indent', 'outdent'],
                    ['table', 'link'],
                    ['code', 'codeblock']
                ]
            });

            page.searchMain();


        })

        // 설계도 첨부 파일 선택 완료후 화면에 표시
        $('#drawingFile').on('change', function() {
            const file = this.files[0];
            // 파일이 선택되지 않은 경우
            if (!file) return;

            // 파일 확장자 검사
            const fileName = file.name.toLowerCase();

            // 경고 메시지 표시

            // 파일 선택 초기화 (바인딩 해제)

            Alert.alert('', '선택된 파일: ' + file.name);
            document.getElementById('fileText').value = file.name;
        });

        // 요청사항 저장 버튼 클릭 이벤트
        $('#btnSearch').on('click', function() {
            const content = editor.getHTML(); // 또는 editor.getMarkdown()
            console.log("작성된 내용:", content);

            // Ajax 저장 시
            const data = {
                reqDate: $('#searchDate').val(),
                title: $('#title').val(),
                reqType: $('#reqType').val(),
                content: content
            };
            AjaxUtil.postAsyncData('/api/your/save', data, function(res) {
                if (res.success) {
                    Notify.success('저장되었습니다.');
                }
            });
        });

        // 요청사항 불러오기
        function loadRequestDetail(reqId) {
            const result = AjaxUtil.getSyncData('/api/your/detail', { id: reqId });
            if (result.success && result.data) {
                editor.setHTML(result.data.content || '');
            }
        }
    </script>

</th:block>
</html>