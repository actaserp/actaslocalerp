<html layout:decorate="~{layout_page}">
<head>
    <style>
        .radio-wrap {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .radio-wrap input[type="radio"] {
            appearance: none;
            -webkit-appearance: none; /* 사파리용 */
            width: 16px;
            height: 16px;

            border-radius: 50%;
            position: relative;
            cursor: pointer;
        }

        .radio-wrap input[type="radio"]::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 8px;
            height: 8px;
            background-color: #666;
            border-radius: 50%;
            opacity: 0;
            transition: 0.2s;
        }

        .radio-wrap input[type="radio"]:checked::after {
            opacity: 1;
        }
    </style>
</head>
<th:block layout:fragment="content">
    <div class="layout-contents">
        <div class="tab-wrap">
            <ul class="tab-links">
                <li>
                    <a href="#tab1" title="요청등록" id="listTabLink">요청등록</a>
                </li>
                <li>
                    <a href="#tab2" title="요청현황" id="inputTabLink">요청현황</a>
                </li>
            </ul>
            <div class="tab-contents">
                <section class="tab-item" id="tab1">
                    <div class="section-top">
                        <input type="hidden" id="id" name="id" readonly>
                        <!--첨부 파일 바인드 input-->
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    <label>
                                        요청일자<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="date" id="searchDate" name="searchDate"  />
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        사업자번호<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="text" placeholder=""  id="spNum" name="spNum" readonly/>
                                        <input type="hidden"  id="cboCompanyHidden" name="cboCompanyHidden"  />
                                    </div>
                                </dd>
                            </dl>

                            <dl>
                                <dt>
                                    <label>
                                        요청자
                                    </label>
                                </dt>
                                <dd>
                                    <input type="text" class="form-control2" id="reqPer" name="reqPer" />
                                </dd>
                            </dl>

                            <dl>
                                <dt>
                                    <label>
                                        연락처<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <input type="text" class="form-control2" id="telNum" name="telNum" />
                                </dd>
                            </dl>
                            <dl>
                                <dd>
                                    <li>
                                        <a class="btn btn-delete" title="검색" id="btnClear">
                                            <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                            <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                            신규
                                        </a>
                                        <a class="btn btn-delete" title="검색" id="btnSave">
                                            <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                            <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                            저장
                                        </a>
                                    </li>
                                </dd>
                            </dl>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <dl style="width: 32%">
                                <dt>
                                    <label>
                                        제목<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <input type="text" class="form-control2" id="title" name="title" style="width:100%"/>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        요청구분<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <select type="text" class="form-control2" id="reqType" name="reqType" >
                                    </select>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        화면명<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <input type="text" class="form-control2" id="scrNum" name="scrNum" />
                                </dd>
                            </dl>
                        </div>
                    </div>
                    <div class="" id="reqText">
                        <div class="webEdit" id="webEdit"></div>
                    </div>
                    <div class="" id="" style="display: flex; gap: 10px;">
                        <input type="text" id="fileText" placeholder="파일 찾기">
                        <input type="file" id="drawingFile" accept="application" style="display:none;" />
                        <button type="button" class="btn-excellt" id="btnFile" name="btnFile"
                                style="width: 100px; height: 36px;">
                            파일선택
                        </button>
                    </div>
                </section>
<!--                요청현황 탭-->
                <section class="tab-item" id="tab2">
                    <div class="section-top">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    <label>
                                        조회일자<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="date" id="searchfrdate2" name="searchfrdate2"  />
                                        <span class="slow_sign">~</span>
                                        <input type="date" id="searchtodate2" name="searchtodate2" />
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        업체명<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="text" placeholder=""  id="cboCompany2" name="cboCompany2" readonly/>
                                        <input type="hidden"  id="cboCompanyHidden2" name="cboCompanyHidden2"  />
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        요청구분<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <select id="reqType2"></select>
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>&nbsp;</dt>
                                <dd>
                                    <li>
                                        <a class="btn btn-delete" title="검색" id="btnSearch2">
                                            <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                            <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                            검색
                                        </a>
                                    </li>
                                </dd>
                            </dl>

                        </div>
                    </div>
                    <div>
                        <div id="theGrid_reqList" style="height: 430px;"></div>
                    </div>
                    <div style="margin-top: 10px; display:flex; gap: 15px;">
                        <dl style="width: 45%;">
                            <dt>
                                <label>
                                    요청내용<span class="eq"></span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <textarea placeholder=""  id="reqtextf" name="reqtextf" readonly>

                                    </textarea>
                                </div>
                            </dd>
                        </dl>
                        <dl style="width: 45%;">
                            <dt>
                                <label>
                                    처리내용<span class="eq"></span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <textarea placeholder=""  id="reqtextf2" name="reqtextf2" readonly>

                                    </textarea>
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label>
                                    완료일자<span class="eq"></span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <input placeholder=""  id="enddate" name="enddate" readonly/>
                                </div>
                            </dd>
                            <dt>
                                <label>
                                    <span class="eq"></span>
                                </label>
                            </dt>
                            <dd>
                                <button type="button" class="btn-excellt" id="download" name="download"
                                        style="width: 100px; height: 36px;">
                                    다운로드
                                </button>
                            </dd>
                        </dl>
                    </div>
                </section>
            </div>
        </div>


    </div>
</th:block>

<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting" ></th:block>
    <th:block th:replace="/common/popup_account :: popup_account" />
    <th:block th:replace="/common/popup_company :: popup_company"></th:block>
    <th:block th:replace="/shipment/trade_stmt/trade_stmt_tmpl :: printTemplate"></th:block>
    <!-- Toast UI Editor CSS -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <!-- Toast UI Editor JS -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

    <script type="text/javascript">


        let sales_type = [];
        let LoadingFlag = false;
        let editor;
        class SalesList {
            constructor() {
                this.grid1 = null;
                this.url = '/api/request';


                this.viewData = new wijmo.collections.CollectionView();


                $('#searchfrdate2').val(getNowDateMinus7());
                $('#searchDate, #searchtodate2').val(getNowDate());
                AjaxUtil.fillSelectOptions($('#reqType'), 'system_code', 'choose', false, 'asdv');
                AjaxUtil.fillSelectOptions($('#reqType2'), 'system_code', 'choose', false, 'asdv');

                this.init();
            }

            init() {
                let _this = this;

                const cv = _this.viewData

                // 그룹화 제거 (필요시 주석 해제)
                // cv.groupDescriptions.push(new wijmo.collections.PropertyGroupDescription('asdate', function (item, prop) {
                //     return item[prop] ? item[prop].substring(0, 7) : ''; // '2025-04'
                // }));

                // 3. FlexGrid 생성
                this.grid1 = new wijmo.grid.FlexGrid('#theGrid_reqList', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    allowSorting: 'MultiColumn',
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    isReadOnly: true,
                    columns: [
                        { binding: 'id', header: 'ID', visible: false },
                        { binding: 'asdate', header: '요청일자', align: 'center', width: 120 },
                        { binding: 'cltnm', header: '업체명', align: 'left', width: 150 },
                        { binding: 'usernm', header: '요청자', align: 'left', width: 120},
                        { binding: 'retitle', header: '제목', align: 'left', width: '*' },
                        { binding: 'asdv_nm', header: '요청구분', align: 'center', width: 120 },
                        { binding: 'asmenu', header: '화면명', align: 'left', width: 150 },
                        { binding: 'aspernm', header: '본사담당', align: 'left', width: 120 },
                        { binding: 'recyn_nm', header: '진행구분', align: 'center', width: 120 },
                        { binding: 'inputdate', header: '입력일자', align: 'center', width: 150 },
                    ],
                    itemsSource: cv,

                });
                this.grid1.rowHeaders.columns.splice(0, 1);
                new FlexGridContextMenu(this.grid1);
                this.grid1.downloadFileName = '유지보수_요청현황';

                // 그룹 병합 설정 제거 (필요시 주석 해제)
                // this.grid1.allowMerging = wijmo.grid.AllowMerging.All;
                // this.grid1.columns[0].allowMerging = true;
                // this.grid1.columns[1].allowMerging = true;

                // 그리드 선택 이벤트 - 상세 정보 표시
                this.grid1.selectionChanged.addHandler((s, e) => {
                    const row = s.selection.row;
                    if (row < 0) return;

                    const item = s.rows[row].dataItem;
                    if (!item) return;

                    // 요청현황 탭의 상세 정보 영역에 데이터 표시
                    $('#reqtextf').val(item.content || item.reqtext || '');
                    $('#reqtextf2').val(item.procContent || item.procText || '');
                    $('#enddate').val(item.endDate || item.enddate || '');
                });

                // 그리드 더블클릭 이벤트 - 상세 조회 및 수정
                this.grid1.hostElement.addEventListener('dblclick', (e) => {
                    const view = this.grid1;
                    const selected = view.selectedItems;

                    if (!selected || selected.length !== 1) {
                        Alert.alert('', '선택된 데이터가 없습니다.');
                        return;
                    }

                    const item = selected[0];
                    this.loadRequestDetail(item);
                });

            }


            searchMain(){
                let _this = this;

                let data = {
                    searchfrdate: $('#searchfrdate2').val(),
                    searchtodate: $('#searchtodate2').val(),
                    searchCompCd: $('#cboCompanyHidden2').val(),
                    reqType : $('#reqType2').val(),
                    spjangcd: getSpjangcdFromSession(),
                }

                let url = _this.url + '/search';
                let fnsuccess = function (result) {
                    if (result != null && result.data) {
                        _this.viewData.sourceCollection = result.data;
                    } else {
                        _this.viewData.sourceCollection = [];
                    }
                };
                AjaxUtil.getAsyncData(url, data, fnsuccess);
            }

            saveRequest() {
                let _this = this;
                
                // Toast UI Editor에서 HTML 내용 가져오기
                const content = editor.getHTML();
                
                // 폼 데이터 수집
                let data = {
                    id: $('#id').val() || '',
                    reqDate: $('#searchDate').val(),
                    spNum: $('#spNum').val(),
                    cboCompanyHidden: $('#cboCompanyHidden').val(),
                    reqPer: $('#reqPer').val(),
                    telNum: $('#telNum').val(),
                    title: $('#title').val(),
                    reqType: $('#reqType').val(),
                    scrNum: $('#scrNum').val(),
                    content: content,
                    spjangcd: getSpjangcdFromSession(),
                };

                // 파일이 선택된 경우 파일명만 전송 (실제 파일 업로드는 별도 처리 필요)
                const fileInput = document.getElementById('drawingFile');
                if (fileInput && fileInput.files && fileInput.files.length > 0) {
                    data.fileName = fileInput.files[0].name;
                    // TODO: 실제 파일 업로드는 별도 API로 처리하거나 FormData로 전송 필요
                }

                // JSON 데이터로 저장
                AjaxUtil.postJsonData(_this.url + '/save', data, function(res) {
                    if (res.success) {
                        Notify.success('저장되었습니다.');
                        _this.clearForm();
                        _this.searchMain();
                    } else {
                        Alert.alert('저장 실패', res.message || '관리자에게 문의하세요.');
                    }
                });
            }

            clearForm() {
                $('#id').val('');
                $('#searchDate').val(getNowDate());
                $('#spNum').val('');
                $('#cboCompanyHidden').val('');
                $('#reqPer').val('');
                $('#telNum').val('');
                $('#title').val('');
                $('#reqType').val('');
                $('#scrNum').val('');
                $('#fileText').val('');
                $('#drawingFile').val('');
                if (editor) {
                    editor.setHTML('');
                }
            }

            loadRequestDetail(item) {
                let _this = this;
                
                if (!item || !item.id) {
                    return;
                }

                let params = {
                    id: item.id,
                    action: 'detail'
                };

                AjaxUtil.getAsyncData(_this.url + '/detail', params, function(result) {
                    if (result && result.data) {
                        const data = result.data;
                        
                        // 폼에 데이터 바인딩
                        $('#id').val(data.id || '');
                        $('#searchDate').val(data.reqDate || getNowDate());
                        $('#spNum').val(data.spNum || '');
                        $('#cboCompanyHidden').val(data.cboCompanyHidden || '');
                        $('#reqPer').val(data.reqPer || '');
                        $('#telNum').val(data.telNum || '');
                        $('#title').val(data.title || '');
                        $('#reqType').val(data.reqType || '');
                        $('#scrNum').val(data.scrNum || '');
                        
                        // 에디터에 내용 설정
                        if (editor && data.content) {
                            editor.setHTML(data.content);
                        }
                        
                        // 파일명 표시 (파일이 있는 경우)
                        if (data.fileName) {
                            $('#fileText').val(data.fileName);
                        }
                        
                        // 탭 전환
                        $('#listTabLink').trigger('click');
                    }
                });
            }



        }

        let page = null;


        $(document).ready(function (e) {
            page = new SalesList();

            // $('#cboCompany').click(function(){
            //     companyPopupOpen('cboCompany', 'cboCompanyHidden');
            // });
            // $('#cboCompany2').click(function(){
            //     companyPopupOpen('cboCompany2', 'cboCompanyHidden2');
            // });

            // 조회 버튼 (요청현황 탭)
            $('#btnSearch2').click(function(){
                page.searchMain();
            });

            // 저장 버튼
            $('#btnSave').on('click', function() {
                // 필수 필드 검증
                if (!$('#searchDate').val()) {
                    Alert.alert('', '요청일자를 입력하세요.');
                    return;
                }
                if (!$('#title').val()) {
                    Alert.alert('', '제목을 입력하세요.');
                    return;
                }

                Alert.confirm('', '저장하시겠습니까?', function() {
                    page.saveRequest();
                });
            });

            // 신규 버튼
            $('#btnClear').on('click', function() {
                Alert.confirm('', '새로 작성하시겠습니까?', function() {
                    page.clearForm();
                });
            });

            // 파일선택 버튼 클릭 시, 파일 선택창 실행
            $(document).on('click', '#btnFile, #fileText', function() {
                $('#drawingFile').click();
            });

            // ✅ Toast UI Editor 생성
            editor = new toastui.Editor({
                el: document.querySelector('#webEdit'),  // 에디터 붙일 요소
                height: '500px',                         // 높이
                initialEditType: 'wysiwyg',              // 'markdown' 도 가능
                previewStyle: 'vertical',                // 미리보기 스타일
                initialValue: '',                        // 초기 내용
                placeholder: '요청 내용을 입력하세요...',
                toolbarItems: [                             // 툴바 설정
                    ['heading', 'bold', 'italic', 'strike'],
                    ['hr', 'quote'],
                    ['ul', 'ol', 'task', 'indent', 'outdent'],
                    ['table', 'link'],
                    ['code', 'codeblock']
                ]
            });

            // 초기 조회 실행
            page.searchMain();

        })

        // 파일첨부 저장 로직
        $('#drawingFile').on('change', function() {
            const file = this.files[0];
            // 파일이 선택되지 않은 경우
            if (!file) return;

            // 파일명 표시
            document.getElementById('fileText').value = file.name;
        });
    </script>

</th:block>
</html>