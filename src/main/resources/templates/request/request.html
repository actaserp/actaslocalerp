<html layout:decorate="~{layout_page}">
<head>
    <style>
        .radio-wrap {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .radio-wrap input[type="radio"] {
            appearance: none;
            -webkit-appearance: none; /* ì‚¬íŒŒë¦¬ìš© */
            width: 16px;
            height: 16px;

            border-radius: 50%;
            position: relative;
            cursor: pointer;
        }

        .radio-wrap input[type="radio"]::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 8px;
            height: 8px;
            background-color: #666;
            border-radius: 50%;
            opacity: 0;
            transition: 0.2s;
        }

        .radio-wrap input[type="radio"]:checked::after {
            opacity: 1;
        }
    </style>
</head>
<th:block layout:fragment="content">
    <div class="layout-contents">
        <div class="tab-wrap">
            <ul class="tab-links">
                <li>
                    <a href="#tab1" title="ìš”ì²­ë“±ë¡" id="listTabLink">ìš”ì²­ë“±ë¡</a>
                </li>
                <li>
                    <a href="#tab2" title="ìš”ì²­í˜„í™©" id="inputTabLink">ìš”ì²­í˜„í™©</a>
                </li>
            </ul>
            <div class="tab-contents">
                <section class="tab-item" id="tab1">
                    <div class="section-top">
                        <input type="hidden" id="id" name="id" readonly>
<!--                        ë³¸ì‚¬ë‹´ë‹¹ì-->
                        <input type="hidden" id="OurManager" name="OurManager" readonly>
<!--                        ê±°ë˜ì²˜ ì½”ë“œ-->
                        <input type="hidden" id="Code" name="Code" readonly>
                        <!--ì²¨ë¶€ íŒŒì¼ ë°”ì¸ë“œ input-->
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    <label>
                                        ìš”ì²­ì¼ì<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="date" id="searchDate" name="searchDate"  />
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        ì‚¬ì—…ìë²ˆí˜¸<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="text" placeholder=""  id="spNum" name="spNum" readonly/>
                                        <input type="hidden"  id="cboCompanyHidden" name="cboCompanyHidden"  />
                                    </div>
                                </dd>
                            </dl>

                            <dl>
                                <dt>
                                    <label>
                                        ìš”ì²­ì
                                    </label>
                                </dt>
                                <dd>
                                    <input type="text" class="form-control2" id="reqPer" name="reqPer" />
                                </dd>
                            </dl>

                            <dl>
                                <dt>
                                    <label>
                                        ì—°ë½ì²˜<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <input type="text" class="form-control2" id="telNum" name="telNum" />
                                </dd>
                            </dl>
                            <dl>
                                <dd>
                                    <li>
                                        <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnClear">
                                            <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                            ì‹ ê·œ ì´ˆê¸°í™”
                                        </a>
                                        <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSave">
                                            <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                            <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                            ì €ì¥
                                        </a>
                                        <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnDelete">
                                            <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                            ì‚­ì œ
                                        </a>
                                    </li>
                                </dd>
                            </dl>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <dl style="width: 32%">
                                <dt>
                                    <label>
                                        ì œëª©<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <input type="text" class="form-control2" id="title" name="title" style="width:100%"/>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        ìš”ì²­êµ¬ë¶„<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <select type="text" class="form-control2" id="reqType" name="reqType" >
                                    </select>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        í™”ë©´ëª…<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <input type="text" class="form-control2" id="scrNum" name="scrNum" />
                                </dd>
                            </dl>
                        </div>
                    </div>
                    <div class="" id="reqText">
                        <div class="webEdit" id="webEdit"></div>
                    </div>
                    <div class="" id="fileBoxArea" style="display: flex; gap: 10px;">
                        <input type="text" id="fileText" placeholder="íŒŒì¼ ì°¾ê¸°">
                        <input type="file" id="drawingFile" accept="application" style="display:none;" />
                        <button type="button" class="btn-excellt" id="btnFile" name="btnFile"
                                style="width: 100px; height: 36px;">
                            íŒŒì¼ì„ íƒ
                        </button>
                    </div>
                </section>
<!--                ìš”ì²­í˜„í™© íƒ­-->
                <section class="tab-item" id="tab2">
                    <div class="section-top">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    <label>
                                        ì¡°íšŒì¼ì<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="date" id="searchfrdate2" name="searchfrdate2"  />
                                        <span class="slow_sign">~</span>
                                        <input type="date" id="searchtodate2" name="searchtodate2" />
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        ì—…ì²´ëª…<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="text" placeholder=""  id="cboCompany2" name="cboCompany2" readonly/>
                                        <input type="hidden"  id="cboCompanyHidden2" name="cboCompanyHidden2"  />
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        ìš”ì²­êµ¬ë¶„<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <select id="reqType2"></select>
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>&nbsp;</dt>
                                <dd>
                                    <li>
                                        <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch2">
                                            <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                            <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                            ê²€ìƒ‰
                                        </a>
                                    </li>
                                </dd>
                            </dl>

                        </div>
                    </div>
                    <div>
                        <div id="theGrid_reqList" style="height: 430px;"></div>
                    </div>
                    <div style="margin-top: 10px; display:flex; gap: 15px;">
                        <dl style="width: 45%;">
                            <dt>
                                <label>
                                    ìš”ì²­ë‚´ìš©<span class="eq"></span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <textarea placeholder=""  id="reqtextf" name="reqtextf" readonly>

                                    </textarea>
                                </div>
                            </dd>
                        </dl>
                        <dl style="width: 45%;">
                            <dt>
                                <label>
                                    ì²˜ë¦¬ë‚´ìš©<span class="eq"></span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <textarea placeholder=""  id="reqtextf2" name="reqtextf2" readonly>

                                    </textarea>
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label>
                                    ì™„ë£Œì¼ì<span class="eq"></span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <input placeholder=""  id="enddate" name="enddate" readonly/>
                                </div>
                            </dd>
                            <dt>
                                <label>
                                    <span class="eq"></span>
                                </label>
                            </dt>
                            <dd>
                                <button type="button" class="btn-excellt" id="download" name="download"
                                        style="width: 100px; height: 36px;">
                                    ì™„ë£Œì²¨ë¶€
                                </button>
                            </dd>
                        </dl>
                    </div>
                </section>
            </div>
        </div>


    </div>
</th:block>

<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting" ></th:block>
    <th:block th:replace="/common/popup_account :: popup_account" />
    <th:block th:replace="/common/popup_company :: popup_company"></th:block>
    <th:block th:replace="/shipment/trade_stmt/trade_stmt_tmpl :: printTemplate"></th:block>
    <!-- Toast UI Editor CSS -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <!-- Toast UI Editor JS -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

    <script type="text/javascript">


        let sales_type = [];
        let LoadingFlag = false;
        let editor;
        class SalesList {
            constructor() {
                this.grid1 = null;
                this.url = '/api/request';


                this.viewData = new wijmo.collections.CollectionView();


                $('#searchfrdate2').val(getNowDateMinus7());
                $('#searchDate, #searchtodate2').val(getNowDate());
                AjaxUtil.fillSelectOptions($('#reqType'), 'system_code', 'choose', false, 'asdv');
                AjaxUtil.fillSelectOptions($('#reqType2'), 'system_code', 'all', false, 'asdv');

                this.init();
            }

            init() {
                let _this = this;

                const cv = _this.viewData

                // ê·¸ë£¹í™” ì œê±° (í•„ìš”ì‹œ ì£¼ì„ í•´ì œ)
                // cv.groupDescriptions.push(new wijmo.collections.PropertyGroupDescription('asdate', function (item, prop) {
                //     return item[prop] ? item[prop].substring(0, 7) : ''; // '2025-04'
                // }));

                // 3. FlexGrid ìƒì„±
                this.grid1 = new wijmo.grid.FlexGrid('#theGrid_reqList', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    allowSorting: 'MultiColumn',
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    isReadOnly: true,
                    columns: [
                        { binding: 'id', header: 'ID', visible: false },
                        { binding: 'asdate', header: 'ìš”ì²­ì¼ì', align: 'center', width: 120 },
                        { binding: 'cltnm', header: 'ì—…ì²´ëª…', align: 'left', width: 150 },
                        { binding: 'usernm', header: 'ìš”ì²­ì', align: 'left', width: 120},
                        { binding: 'retitle', header: 'ì œëª©', align: 'left', width: '*' },
                        { binding: 'asdv_nm', header: 'ìš”ì²­êµ¬ë¶„', align: 'center', width: 120 },
                        { binding: 'asmenu', header: 'í™”ë©´ëª…', align: 'left', width: 150 },
                        { binding: 'aspernm', header: 'ë³¸ì‚¬ë‹´ë‹¹', align: 'left', width: 120 },
                        { binding: 'recyn_nm', header: 'ì§„í–‰êµ¬ë¶„', align: 'center', width: 120 },
                        { binding: 'inputdate', header: 'ì…ë ¥ì¼ì', align: 'center', width: 150 },
                    ],
                    itemsSource: cv,

                });
                this.grid1.rowHeaders.columns.splice(0, 1);
                new FlexGridContextMenu(this.grid1);
                this.grid1.downloadFileName = 'ìœ ì§€ë³´ìˆ˜_ìš”ì²­í˜„í™©';

                // ê·¸ë£¹ ë³‘í•© ì„¤ì • ì œê±° (í•„ìš”ì‹œ ì£¼ì„ í•´ì œ)
                // this.grid1.allowMerging = wijmo.grid.AllowMerging.All;
                // this.grid1.columns[0].allowMerging = true;
                // this.grid1.columns[1].allowMerging = true;

                // ê·¸ë¦¬ë“œ ì„ íƒ ì´ë²¤íŠ¸ - ìƒì„¸ ì •ë³´ í‘œì‹œ
                this.grid1.selectionChanged.addHandler((s, e) => {
                    const row = s.selection.row;
                    if (row < 0) return;

                    const item = s.rows[row].dataItem;
                    if (!item) return;

                    // âœ… HTML íƒœê·¸ ì œê±° (ì›¹ì—ë””í„° ë‚´ìš©ì—ì„œ ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ)
                    const plainContent = (item.content || '').replace(/<[^>]+>/g, '');
                    const plainRemark = (item.remark || '').replace(/<[^>]+>/g, '');

                    // ìš”ì²­í˜„í™© íƒ­ì˜ ìƒì„¸ ì •ë³´ ì˜ì—­ì— ë°ì´í„° í‘œì‹œ
                    $('#reqtextf').val(plainContent);
                    $('#reqtextf2').val(plainRemark);
                    $('#enddate').val(item.endDate || item.enddate || '');
                });

                // ê·¸ë¦¬ë“œ ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ - ìƒì„¸ ì¡°íšŒ ë° ìˆ˜ì •
                this.grid1.hostElement.addEventListener('dblclick', (e) => {
                    const view = this.grid1;
                    const selected = view.selectedItems;

                    if (!selected || selected.length !== 1) {
                        Alert.alert('', 'ì„ íƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    const item = selected[0];
                    this.loadRequestDetail(item);
                });

            }


            searchMain(){
                let _this = this;

                let data = {
                    searchfrdate: $('#searchfrdate2').val(),
                    searchtodate: $('#searchtodate2').val(),
                    searchCompCd: $('#cboCompanyHidden2').val(),
                    reqType : $('#reqType2').val(),
                    spjangcd: getSpjangcdFromSession(),
                }

                let url = _this.url + '/search';
                let fnsuccess = function (result) {
                    if (result != null && result.data) {
                        _this.viewData.sourceCollection = result.data;
                    } else {
                        _this.viewData.sourceCollection = [];
                    }
                };
                AjaxUtil.getAsyncData(url, data, fnsuccess);
            }

            saveRequest() {
                let _this = this;
                const content = editor.getHTML();

                let data = {
                    id: $('#id').val() || '',
                    reqDate: $('#searchDate').val(),
                    spNum: $('#spNum').val(),
                    cboCompanyHidden: $('#cboCompanyHidden').val(),
                    reqPer: $('#reqPer').val(),
                    telNum: $('#telNum').val(),
                    title: $('#title').val(),
                    reqType: $('#reqType').val(),
                    scrNum: $('#scrNum').val(),
                    Code: $('#Code').val(),
                    OurManager: $('#OurManager').val(),
                    content: content,
                    spjangcd: getSpjangcdFromSession(),
                };

                let file = $('#drawingFile')[0].files[0];

                if (file) {
                    // âœ… AjaxUtilì„ í™œìš©í•´ íŒŒì¼ ì—…ë¡œë“œ
                    let formData = new FormData();
                    formData.append('uploadFile', file);

                    AjaxUtil.postFileAsyncData(
                        '/api/request/uploadFile',
                        formData,
                        function (res) {
                            if (res.success) {
                                console.log("ì—…ë¡œë“œ ì„±ê³µ:", res.data);
                                data.as_file = res.data;
                                _this.saveRequestData(data);
                            } else {
                                Alert.alert('', 'íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + res.message);
                            }
                        },
                        function (req, status, error) {
                            console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', req.responseText);
                            Alert.alert('ì˜¤ë¥˜', 'íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ (' + req.status + ')');
                        }
                    );
                } else {
                    _this.saveRequestData(data);
                }
            }



            saveRequestData(data) {
                let _this = this;
                AjaxUtil.postJsonData(_this.url + '/save', data, function(res) {
                    if (res.success) {
                        Notify.success('ì €ì¥(ìˆ˜ì •)ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        _this.clearForm();
                        _this.searchMain();
                    } else {
                        Alert.alert('ì €ì¥(ìˆ˜ì •) ì‹¤íŒ¨', res.message || 'ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                    }
                });
            }

            clearForm() {
                // ğŸ”¹ í¼ ì „ì²´ í´ë¦¬ì–´ (ìœ ì§€ ëŒ€ìƒ ì œì™¸)
                $('#id').val('');
                $('#searchDate').val(getNowDate());
                $('#title').val('');
                $('#reqType').val('');
                $('#scrNum').val('');
                $('#fileText').val('');
                $('#drawingFile').val('');
                if (editor) editor.setHTML('');
                // âœ… íŒŒì¼ ì²¨ë¶€ ì˜ì—­ ì™„ì „ ì´ˆê¸°í™”
                const $fileBox = $('#fileBoxArea');
                $fileBox.html(`
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="fileText" placeholder="íŒŒì¼ ì°¾ê¸°" readonly style="flex: 1;" />
                        <input type="file" id="drawingFile" accept="application" style="display:none;" />
                        <button
                            type="button"
                            class="btn-excellt"
                            id="btnFile"
                            name="btnFile"
                            style="width: 100px; height: 36px; cursor:pointer;"
                        >
                            íŒŒì¼ì„ íƒ
                        </button>
                    </div>
                `);

                // âœ… íŒŒì¼ ì„ íƒ ì‹œ íŒŒì¼ëª… í‘œì‹œ ì´ë²¤íŠ¸ ë‹¤ì‹œ ì—°ê²°
                $(document).off('change.drawingFile').on('change.drawingFile', '#drawingFile', function() {
                    const fileObj = this.files[0];
                    if (!fileObj) return;
                    $('#fileText').val(fileObj.name);
                });
                // ğŸ”¹ ìœ ì§€í•  í•„ë“œ: ì„¸ì…˜ ê¸°ë°˜ / ìë™ ë°”ì¸ë”©ëœ ì •ë³´
                // ê·¸ëŒ€ë¡œ ë‘ :
                // #spNum
                // #reqPer
                // #cboCompany2
                // #cboCompanyHidden / #cboCompanyHidden2
                // #Code / #OurManager
            }

            loadRequestDetail(item) {
                let _this = this;
                if (!item || !item.id) return;

                let params = {
                    id: item.id,
                    action: 'detail'
                };

                AjaxUtil.getAsyncData(_this.url + '/detail', params, function(result) {
                    if (result && result.data) {
                        const data = result.data;

                        // âœ… ê¸°ë³¸ì •ë³´ ë°”ì¸ë”©
                        $('#id').val(data.id || '');
                        $('#searchDate').val(data.reqDate || getNowDate());
                        $('#spNum').val(data.userid || '');
                        $('#cboCompanyHidden').val(data.Code || '');
                        $('#reqPer').val(data.reqper || '');
                        $('#telNum').val(data.TelNumber || '');
                        $('#title').val(data.title || '');
                        $('#reqType').val(data.reqtype || '');
                        $('#scrNum').val(data.scrnum || '');
                        $('#Code').val(data.Code || '');
                        $('#OurManager').val(data.ourmanager || '');
                        $('#spjangcd').val(data.spjangcd || '');

                        // âœ… ì—ë””í„° ë‚´ìš© ë³µì›
                        if (editor) {
                            editor.setHTML(data.content || '');
                        }

                        // âœ… íƒ­ ì „í™˜ (ìš”ì²­ë“±ë¡ íƒ­ìœ¼ë¡œ ì´ë™)
                        $('#listTabLink').trigger('click');

                        // âœ… íƒ­ ì „í™˜ ì™„ë£Œ í›„ íŒŒì¼ í‘œì‹œ/ìˆ˜ì • ê°€ëŠ¥ ì˜ì—­ êµ¬ì„±
                        setTimeout(() => {
                            const $fileBox = $('#fileBoxArea'); // í™•ì‹¤í•œ ì„ íƒì

                            if (data.as_file && data.as_file.trim() !== '') {
                                const fileName = data.as_file;

                                // ê¸°ì¡´ ì²¨ë¶€ + ë‹¤ìš´ë¡œë“œ + íŒŒì¼ë³€ê²½ ëª¨ë‘ ê°€ëŠ¥í•˜ë„ë¡ êµ¬ì„±
                                $fileBox.html(`
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input
                                            type="text"
                                            id="fileText"
                                            value="ì²¨ë¶€íŒŒì¼ ì¡´ì¬"
                                            readonly
                                            style="flex: 1; color:#333;"
                                        />
                                        <input type="file" id="drawingFile" accept="application" style="display:none;" />
                                        <button
                                            type="button"
                                            class="btn-excellt"
                                            id="btnDownload"
                                            name="btnDownload"
                                            style="width: 110px; height: 36px; cursor: pointer;"
                                            data-filename="${fileName}"
                                        >
                                            ë‹¤ìš´ë¡œë“œ
                                        </button>
                                        <button
                                            type="button"
                                            class="btn-excellt"
                                            id="btnFile"
                                            name="btnFile"
                                            style="width: 100px; height: 36px; cursor:pointer;"
                                        >
                                            íŒŒì¼ì„ íƒ
                                        </button>
                                    </div>
                                `);

                                // ë‹¤ìš´ë¡œë“œ ì´ë²¤íŠ¸ ë“±ë¡
                                $('#btnDownload').on('click', function() {
                                    const file = $(this).data('filename');
                                    if (file) {
                                        window.open('/api/request/downFile?fileName=' + encodeURIComponent(file), '_blank');
                                    }
                                });

                                // íŒŒì¼ëª… í‘œì‹œ (íŒŒì¼ ë³€ê²½ ì‹œ)
                                $(document).off('change.drawingFile').on('change.drawingFile', '#drawingFile', function() {
                                    const fileObj = this.files[0];
                                    if (!fileObj) return;
                                    $('#fileText').val(fileObj.name);
                                });

                            } else {
                                // íŒŒì¼ì´ ì—†ì„ ë•Œ ê¸°ë³¸ ì…ë ¥ì°½ ë³µì›
                                $fileBox.html(`
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="text" id="fileText" placeholder="íŒŒì¼ ì°¾ê¸°" readonly style="flex: 1;" />
                                        <input type="file" id="drawingFile" accept="application" style="display:none;" />
                                        <button
                                            type="button"
                                            class="btn-excellt"
                                            id="btnFile"
                                            name="btnFile"
                                            style="width: 100px; height: 36px; cursor:pointer;"
                                        >
                                            íŒŒì¼ì„ íƒ
                                        </button>
                                    </div>
                                `);

                                // íŒŒì¼ëª… í‘œì‹œ (íŒŒì¼ ì„ íƒ ì‹œ)
                                $(document).off('change.drawingFile').on('change.drawingFile', '#drawingFile', function() {
                                    const fileObj = this.files[0];
                                    if (!fileObj) return;
                                    $('#fileText').val(fileObj.name);
                                });
                            }
                        }, 200); // íƒ­ ë Œë” ì™„ë£Œ í›„ ì‹¤í–‰
                    }
                });
            }

        }

        let page = null;


        $(document).ready(function (e) {
            page = new SalesList();

            // âœ… ì„¸ì…˜ì—ì„œ ë¡œê·¸ì¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
            const userId = sessionStorage.getItem('userid');     // ì‚¬ì—…ìë²ˆí˜¸
            const userName = sessionStorage.getItem('username'); // ì—…ì²´ëª…

            // âœ… ê¸°ë³¸ í‘œì‹œ
            if (userId) {
                $('#spNum').val(userId); // ì‚¬ì—…ìë²ˆí˜¸ë§Œ í‘œì‹œ (hiddenì—ëŠ” ì•ˆ ë„£ìŒ)
            }
            if (userName) {
                $('#reqPer').val(userName);
                $('#cboCompany2').val(userName);
            }

            // âœ… íšŒì‚¬ ID ì¡°íšŒ í›„ ë°˜ì˜ ë° ì¡°íšŒ ì‹¤í–‰
            if (userId) {
                $.ajax({
                    url: '/api/request/searchUser',
                    type: 'GET',
                    data: { compid: userId },
                    success: function (res) {
                        if (res && res.data) {
                            const c = res.data;
                            $('#cboCompanyHidden').val(c.Code);
                            $('#cboCompanyHidden2').val(c.Code);
                            $('#cboCompany2').val(c.Name || '');
                            $('#telNum').val(c.TelNumber || '');
                            $('#Code').val(c.Code || '');
                            $('#OurManager').val(c.OurManager || '');
                            page.searchMain(); // âœ… ì´ì œ ì•ˆì „
                        }
                    }
                });
            }




            // $('#cboCompany').click(function(){
            //     companyPopupOpen('cboCompany', 'cboCompanyHidden');
            // });
            // $('#cboCompany2').click(function(){
            //     companyPopupOpen('cboCompany2', 'cboCompanyHidden2');
            // });

            // ì¡°íšŒ ë²„íŠ¼ (ìš”ì²­í˜„í™© íƒ­)
            $('#btnSearch2').click(function(){
                page.searchMain();
            });

            // ì €ì¥ ë²„íŠ¼
            $('#btnSave').on('click', function() {
                // í•„ìˆ˜ í•„ë“œ ê²€ì¦
                if (!$('#searchDate').val()) {
                    Alert.alert('', 'ìš”ì²­ì¼ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }
                if (!$('#title').val()) {
                    Alert.alert('', 'ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }

                Alert.confirm('', 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function() {
                    page.saveRequest();
                });
            });

            // ì‹ ê·œ ë²„íŠ¼
            $('#btnClear').on('click', function() {
                Alert.confirm('', 'ìƒˆë¡œ ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function() {
                    page.clearForm();
                });
            });

            // íŒŒì¼ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ, íŒŒì¼ ì„ íƒì°½ ì‹¤í–‰
            $(document).on('click', '#btnFile, #fileText', function() {
                $('#drawingFile').click();
            });

            // âœ… Toast UI Editor ìƒì„±
            editor = new toastui.Editor({
                el: document.querySelector('#webEdit'),  // ì—ë””í„° ë¶™ì¼ ìš”ì†Œ
                height: '500px',                         // ë†’ì´
                initialEditType: 'wysiwyg',              // 'markdown' ë„ ê°€ëŠ¥
                previewStyle: 'vertical',                // ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼
                initialValue: '',                        // ì´ˆê¸° ë‚´ìš©
                placeholder: 'ìš”ì²­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...',
                toolbarItems: [                             // íˆ´ë°” ì„¤ì •
                    ['heading', 'bold', 'italic', 'strike'],
                    ['hr', 'quote'],
                    ['ul', 'ol', 'task', 'indent', 'outdent'],
                    ['table', 'link'],
                    ['code', 'codeblock']
                ]
            });

            if (parent && parent.$) {
                parent.$('#navbarBarMenu2 .open_menu').trigger('click');
            }

        })

        // íŒŒì¼ì²¨ë¶€ ì €ì¥ ë¡œì§
        $('#drawingFile').on('change', function() {
            const file = this.files[0];
            // íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš°
            if (!file) return;

            // íŒŒì¼ëª… í‘œì‹œ
            document.getElementById('fileText').value = file.name;
        });

        // íŒŒì¼ ì„ íƒ ì‹œ íŒŒì¼ëª… í‘œì‹œ (ìœ„ì„ ë°©ì‹)
        $(document).on('change', '#drawingFile', function() {
            const file = this.files[0];
            if (!file) return;
            $('#fileText').val(file.name);
        });

        // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        $(document).on('click', '#btnDelete', function() {
            const id = $('#id').val(); // í˜„ì¬ ì„ íƒëœ ìš”ì²­ ID

            if (!id) {
                Alert.alert('', 'ì‚­ì œí•  ë°ì´í„°ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            Alert.confirm('ì‚­ì œ í™•ì¸', 'ì„ íƒí•œ ìš”ì²­ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function() {
                let data = { id: id };

                // âœ… AjaxUtil ì‚¬ìš© â†’ CSRF ìë™ ì²˜ë¦¬ë¨
                AjaxUtil.postAsyncData('/api/request/delete', data, function(res) {
                    if (res && res.success) {
                        Notify.success('ìš”ì²­ì‚¬í•­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

                        // âœ… í¼ ì´ˆê¸°í™” (ì…ë ¥í¼ ë‚´ìš© ëª¨ë‘ ë¹„ìš°ê¸°)
                        $('#id').val('');
                        $('#searchDate').val(getNowDate());
                        $('#title').val('');
                        $('#reqType').val('');
                        $('#scrNum').val('');
                        $('#fileText').val('');
                        $('#drawingFile').val('');
                        if (editor) editor.setHTML('');

                        // âœ… ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        if (page && typeof page.searchMain === 'function') {
                            page.searchMain();
                        }

                        // âœ… íƒ­ì„ â€œìš”ì²­í˜„í™©â€ìœ¼ë¡œ ìë™ ì „í™˜
                        $('#inputTabLink').trigger('click');
                    } else {
                        Alert.alert('ì‚­ì œ ì‹¤íŒ¨', res.message || 'ìš”ì²­ì‚¬í•­ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            });
        });

        // ì™„ë£Œì²¨ë¶€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
        $(document).on('click', '#download', function () {
            const grid = wijmo.Control.getControl('#theGrid_reqList');
            const selectedItem = grid.selectedItems[0];

            if (!selectedItem) {
                Alert.alert('', 'ë‹¤ìš´ë¡œë“œí•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            const fileName = selectedItem.fix_file; // âœ… ì¡°íšŒ ê²°ê³¼ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´

            if (!fileName || fileName.trim() === '') {
                Alert.alert('', 'ì™„ë£Œ ì²¨ë¶€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            window.open('/api/request_current/downFile?fileName=' + encodeURIComponent(fileName), '_blank');
        });



    </script>

</th:block>
</html>