<html layout:decorate="~{layout_page}">
<head>
    <style>
        .radio-wrap {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .radio-wrap input[type="radio"] {
            appearance: none;
            -webkit-appearance: none; /* ì‚¬íŒŒë¦¬ìš© */
            width: 16px;
            height: 16px;

            border-radius: 50%;
            position: relative;
            cursor: pointer;
        }

        .radio-wrap input[type="radio"]::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 8px;
            height: 8px;
            background-color: #666;
            border-radius: 50%;
            opacity: 0;
            transition: 0.2s;
        }

        .radio-wrap input[type="radio"]:checked::after {
            opacity: 1;
        }
    </style>
</head>
<th:block layout:fragment="content">
    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>ìš”ì²­í˜„í™©</h2>
                <a title="ë¶ë§ˆí¬" class="bookmark toggle">
                    ë‚´ ë©”ë‰´
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                <li>ìœ ì§€ë³´ìˆ˜</li>
                <li>ìš”ì²­í˜„í™©</li>
            </ul>
        </div>

                <!--                ìš”ì²­í˜„í™© íƒ­-->
                <section class="tab-item" id="tab2">
                    <div class="section-top">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    <label>
                                        ì¡°íšŒì¼ì<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="date" id="searchfrdate2" name="searchfrdate2"  />
                                        <span class="slow_sign">~</span>
                                        <input type="date" id="searchtodate2" name="searchtodate2" />
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        ì—…ì²´ëª…<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="text" placeholder=""  id="cboCompany2" name="cboCompany2"/>
                                        <input type="hidden"  id="cboCompanyHidden2" name="cboCompanyHidden2"  />
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        ìš”ì²­êµ¬ë¶„<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <select id="reqType2"></select>
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        ë³¸ì‚¬ë‹´ë‹¹<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="text" placeholder=""  id="aspernm2" name="aspernm2"/>
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>&nbsp;</dt>
                                <dd>
                                    <li>
                                        <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch2">
                                            <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                            <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                            ê²€ìƒ‰
                                        </a>
                                    </li>
                                </dd>
                            </dl>
                            <dl>
                                <dt>&nbsp;</dt>
                                <dd>
                                    <li>
                                        <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnReceipt">
                                            <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                            <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                            ì ‘ìˆ˜
                                        </a>
                                    </li>
                                </dd>
                            </dl>
                            <dl>
                                <dt>&nbsp;</dt>
                                <dd>
                                    <li>
                                        <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnAddNew">
                                            <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                            <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                            ì²˜ë¦¬ë“±ë¡
                                        </a>
                                    </li>
                                </dd>
                            </dl>

                        </div>
                    </div>
                    <div>
                        <div id="theGrid_reqList" style="height: 430px;"></div>
                    </div>
                    <div style="margin-top: 10px; display:flex; gap: 15px;">
                        <dl style="width: 49%;">
                            <dt style="margin-bottom: 21px;">
                                <label>
                                    ìš”ì²­ë‚´ìš©<span class="eq"></span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <textarea placeholder=""  id="reqtextf" name="reqtextf" readonly>

                                    </textarea>
                                </div>
                            </dd>
                        </dl>
                        <dl style="width: 49%;">
                            <dt>
                                <label style="display: flex;">
                                    ì²˜ë¦¬ë‚´ìš©<span class="eq"></span>
                                    <button type="button" class="btn-excellt" id="download" name="download"
                                            style="width: 100px; height: 36px; margin-left: auto; margin-bottom: 5px;">
                                        ì™„ë£Œì²¨ë¶€
                                    </button>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <textarea placeholder=""  id="reqtextf2" name="reqtextf2" readonly>

                                    </textarea>
                                </div>
                            </dd>
                        </dl>
                    </div>
                </section>
            </div>
        </div>
    </div>
<!--    ì²˜ë¦¬ë“±ë¡ íŒì—…-->
    <script type="text/x-tmpl" id="planTemplate">
        <style>
            /* ì•„ì´í…œ í…Œì´ë¸” ì „ì²´ ì„¤ì • */
            .item-table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed;
                margin-top: 10px;
            }

            /* í—¤ë” ì…€ ìŠ¤íƒ€ì¼ */
            .item-table th {
                background-color: #EDEFF5;
                text-align: center;
                font-weight: bold;
                padding: 8px;
                border: 1px solid #ccc;
            }

            /* ë°”ë”” ì…€ ìŠ¤íƒ€ì¼ */
            .item-table td {
                padding: 6px;
                text-align: center;
                border: 1px solid #ccc;
            }

            /* ì…ë ¥ í•„ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
            .item-table input {
                width: 100%;
                box-sizing: border-box;
                padding: 4px;
            }

            /* í’ˆëª© & ë¹„ê³  ì™¼ìª½ ì •ë ¬ */
            .item-table td:first-child,
            .item-table td:nth-child(6) {
                text-align: left;
            }

            /* ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
            .item-table .btn.in_btn {
                display: inline-flex;
                justify-content: center;
                align-items: center;
                width: 32px;
                height: 32px;
                border-radius: 4px;
                padding: 0;
                border: 1px solid #B3B3B3;
                background-color: #fff;
                cursor: pointer;
                transition: background-color 0.2s;
                line-height: 0;
            }

            /* + ë²„íŠ¼ ì „ìš© ìŠ¤íƒ€ì¼ */
            .item-table .btn.in_btn.plus img {
                width: 10px;
                height: 10px;
                display: block;
            }

            /* ê³µí†µ ì•„ì´ì½˜ ë²„íŠ¼ ì´ë¯¸ì§€ (ì‚­ì œ, ê²€ìƒ‰ í¬í•¨) */
            .item-table .btn.in_btn img {
                width: 12px;
                height: 12px;
                display: block;
                margin-right: 5px;
            }

            /* ëª¨ë‹¬ êµ¬ì¡° */
            .content_wrap.popup {
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
            }

            .table-wrap {
                flex: 1;
                overflow-y: auto;
                padding-right: 5px;
                width: 100%;
            }

            /* í…Œì´ë¸” ì „ì²´ ë°˜ì‘í˜• */
            .write-table,
            .item-table {
                width: 100%;
                table-layout: fixed;
                border-collapse: collapse;
            }

            /* colgroup ì§€ì •ëœ th ì—´ ì¢ê²Œ ì„¤ì • */
            .write-table col.col-th {
                width: 80px !important;
            }

            .write-table col.col-td {
                width: auto;
            }

            .write-table input,
            .write-table select,
            .write-table textarea,
            .item-table input,
            .item-table select,
            .item-table textarea {
                width: 100%;
                box-sizing: border-box;
            }

            /* ê¸°ë³¸ ì…€ ìŠ¤íƒ€ì¼ */
            .write-table th,
            .write-table td {
                border: 1px solid #ccc;
                padding: 6px;
            }

            /* th í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
            .write-table th {
                white-space: nowrap;
                text-align: center;
            }

            .popup-button {
                flex-shrink: 0;
                padding: 10px;
                background: #fff;
                border-top: 1px solid #ddd;
            }
        </style>

        <div class="content_wrap popup">
            <div class="table-wrap">
                <form id="planForm">
                    <table class="write-table">
                        <colgroup>
                            <col style="width:80px">
                            <col style="width:24%">

                            <col style="width:80px">
                            <col style="width:38%">

                            <col style="width:80px">
                            <col style="width:10%">

                            <col style="width:80px">
                            <col style="width:14%">
                        </colgroup>

                        <caption>ë“±ë¡ í…Œì´ë¸”</caption>
                        <input type="hidden" id="id" name="id">

                        <tbody>
                            <tr>
                                <th><label for="rptdate">ì²˜ë¦¬ì¼ì</label></th>
                                <td>
                                    <input class="form-control2" type="date" id="rptdate" name="rptdate" style="min-width:135px;">
                                </td>
                                <th><label for="aspernm">ë³¸ì‚¬ë‹´ë‹¹</label></th>
                                <td>
                                    <div class="input-group" style="display:flex; align-items:center; gap:5px;">
                                        <input type="text" id="aspernm" name="aspernm" style="" readonly>
                                    </div>
                                </td>
                                <th><label for="check020">ì—…ë¬´ì¼ì§€</label></th>
                                <td>
                                    <div>
                                        <input type="checkbox" id="check020" name="check020" style="margin-left: 33%;">
                                    </div>
                                </td>

                                <td colspan="2">
                                    <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnClear">
                                            <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                            <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                            ì‹ ê·œ
                                        </a>
                                        <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSave">
                                            <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                            <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                            ì €ì¥
                                        </a>
                                </td>
                            </tr>

                            <tr>
                                <th><label for="cltnm">ì œëª©</label></th>
                                <td colspan="5">
                                    <input class="form-control2" type="text" id="cltnm" name="cltnm">
                                </td>
                                <th><label for="fixflag">ìš”ì²­êµ¬ë¶„</label></th>
                                <td>
                                    <select class="form-control2" id="fixflag" name="fixflag"></select>
                                </td>
                            </tr>

                            <tr>
                                <th><label for="asmenu">í™”ë©´ëª…</label></th>
                                <td colspan="5">
                                    <input class="form-control2" type="text" id="asmenu" name="asmenu">
                                </td>
                                <th><label for="actflag">ì§„í–‰êµ¬ë¶„</label></th>
                                <td>
                                    <select class="form-control2" id="actflag" name="actflag"></select>
                                </td>
                            </tr>

                            <tr>
                                <th><label>ìš”ì²­ë‚´ìš©</label></th>
                                <td colspan="7">
                                    <div class="webEdit" id="webEdit" style=""></div>
                                </td>
                            </tr>

                            <tr>
                                <th><label for="drawingFile">ì²¨ë¶€íŒŒì¼</label></th>
                                <td colspan="7">
                                    <input type="text" id="fileText" placeholder="íŒŒì¼ ì°¾ê¸°" style="width:80%;">
                                    <input type="file" id="drawingFile" accept="application" style="display:none;" />
                                    <button type="button" class="btn-excellt" id="btnFile" name="btnFile"
                                            style="width: 100px; height: 36px;">
                                        íŒŒì¼ì„ íƒ
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </form>
            </div>

            <div class="popup-button" style="margin-top:0px;">
                <button type="button" class="btn-popup" id="modal-close-button">ë‹«ê¸°</button>
                <button type="button" class="btn-popup y_write_auth" id="btnDelete" style="display:none;">ì‚­ì œ</button>
            </div>
        </div>
    </script>

    <script type="text/x-tmpl" id="getCompTemplate">
        <div class="content_wrap popup">
        <div class="table-wrap">
                <table class="write-table">
                    <caption>ì£¼ë¬¸ë“±ë¡ í…Œì´ë¸”</caption>
                    <tbody>
                        <tr>
                            <th style="text-align: center">
                                <label for="searchCode">ì—…ì²´ì½”ë“œ</label>
                            </th>
                            <td style="width:50px;">
                                <input id="searchCode" name="searchCode" type="text" style="width:180px;" />
                            </td>

                            <th style="text-align: center">
                                <label for="searchName">ê±°ë˜ì²˜ëª…</label>
                            </th>
                            <td style="width:50px;">
                                 <input id="searchName" name="searchName" type="text"  style="width:180px;"/>
                            </td>
                            <td colspan="2" style="text-align: center;">
                                <button type="button" class="btn-default" id="btnSubjectSearch" title="ì¡°íšŒ"><i class="fas fa-search"></i>ê²€ìƒ‰</button>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div class="grid_box" style="margin-top: 10px;">
                    <div id="comp-grid" style="height: 300px; max-height: 300px;"></div>
                </div>
        </div>

        <div class="popup-button">
          <button type="button" class="btn-popup" id="btnAccountSave"><span data-labelCd="ì„ íƒ">ì„ íƒ</span></button>
          <button type="button" class="btn-popup" id="modal-close-button"><span data-labelCd="ë‹«ê¸°">ë‹«ê¸°</span></button>
        </div>
    </div>
    </script>
</th:block>



<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting" ></th:block>
    <th:block th:replace="/common/popup_account :: popup_account" />
    <th:block th:replace="/common/popup_company :: popup_company"></th:block>
    <th:block th:replace="/shipment/trade_stmt/trade_stmt_tmpl :: printTemplate"></th:block>
    <!-- Toast UI Editor CSS -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <!-- Toast UI Editor JS -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

    <script type="text/javascript">


        let sales_type = [];
        let LoadingFlag = false;
        let editor;
        class SalesList {
            constructor() {
                this.grid1 = null;
                this.url = '/api/request_current';
                this.$btnAddNew = $('#btnAddNew');


                this.viewData = new wijmo.collections.CollectionView();


                $('#searchfrdate2').val(getNowDateMinus7());
                $('#searchDate, #searchtodate2').val(getNowDate());
                AjaxUtil.fillSelectOptions($('#reqType2'), 'system_code', 'choose', false, 'asdv');
                AjaxUtil.fillSelectOptions($('#fixflag'), 'system_code', 'choose', false, 'asdv');

                this.init();
            }

            init() {
                let _this = this;

                const cv = _this.viewData

                // 3. FlexGrid ìƒì„±
                this.grid1 = new wijmo.grid.FlexGrid('#theGrid_reqList', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    allowSorting: 'MultiColumn',
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    isReadOnly: true,
                    columns: [
                        { binding: 'id', header: 'ID', visible: false },
                        { binding: 'asdate', header: 'ìš”ì²­ì¼ì', align: 'center', width: 120 },
                        { binding: 'cltnm', header: 'ì—…ì²´ëª…', align: 'left', width: 150 },
                        { binding: 'usernm', header: 'ìš”ì²­ì', align: 'left', width: 120},
                        { binding: 'retitle', header: 'ì œëª©', align: 'left', width: '*' },
                        { binding: 'asdv_nm', header: 'ìš”ì²­êµ¬ë¶„', align: 'center', width: 120 },
                        { binding: 'asmenu', header: 'í™”ë©´ëª…', align: 'left', width: 150 },
                        { binding: 'aspernm', header: 'ë³¸ì‚¬ë‹´ë‹¹', align: 'left', width: 120 },
                        { binding: 'recyn_nm', header: 'ì§„í–‰êµ¬ë¶„', align: 'center', width: 120 },
                        // { binding: 'hasProcess', header: 'ì²˜ë¦¬ì—¬ë¶€', align: 'center', width: 100 },
                        { binding: 'recdate', header: 'ì ‘ìˆ˜ì¼ì', align: 'center', width: 150 },
                        { binding: 'as_file', header: 'ì²¨ë¶€íŒŒì¼', align: 'center', width: 120 },
                    ],
                    itemsSource: cv,
                    // âœ… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì»¬ëŸ¼ í‘œì‹œ
                    formatItem: (s, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.Cell) {
                            const col = s.columns[e.col];
                            const item = s.rows[e.row].dataItem;

                            // ğŸ”¹ as_file ì»¬ëŸ¼ì´ ìˆê³  ê°’ì´ ì¡´ì¬í•  ë•Œë§Œ "ë‹¤ìš´ë¡œë“œ" ë§í¬ í‘œì‹œ
                            if (col.binding === 'as_file' && item && item.as_file) {
                                const safeFileName = item.as_file.replace(/"/g, '&quot;'); // XSS ë°©ì§€
                                e.cell.innerHTML = `
                                    <a href="#" class="file-download" data-file="${safeFileName}" style="
                                        color: #007BFF;
                                        text-decoration: underline;
                                        cursor: pointer;
                                    ">ë‹¤ìš´ë¡œë“œ</a>
                                `;
                            }
                        }
                    },
                });
                this.grid1.rowHeaders.columns.splice(0, 1);
                new FlexGridContextMenu(this.grid1);
                this.grid1.downloadFileName = 'ìš”ì²­ì‚¬í•­_ì²˜ë¦¬í˜„í™©';

                // âœ… ë‹¤ìš´ë¡œë“œ í´ë¦­ ì´ë²¤íŠ¸
                this.grid1.hostElement.addEventListener('click', (e) => {
                    const target = e.target;

                    // ğŸ”¹ í´ë¦­í•œ ìš”ì†Œê°€ 'file-download' í´ë˜ìŠ¤ì¸ì§€ í™•ì¸
                    if (target.classList.contains('file-download')) {
                        e.preventDefault();

                        const fileName = target.dataset.file;
                        if (!fileName) {
                            Alert.alert('', 'íŒŒì¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                            return;
                        }

                        // âœ… ë°±ì—”ë“œ ë§¤í•‘: @GetMapping("/downFile")
                        const downloadUrl = `/api/request/downFile?fileName=${encodeURIComponent(fileName)}`;

                        // âœ… ìƒˆ ì°½ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ (URL ì¸ì½”ë”© ì£¼ì˜)
                        window.open(downloadUrl, '_blank');
                    }
                });

                // ê·¸ë¦¬ë“œ ì„ íƒ ì´ë²¤íŠ¸ - ìƒì„¸ ì •ë³´ í‘œì‹œ
                this.grid1.selectionChanged.addHandler((s, e) => {
                    const row = s.selection.row;
                    if (row < 0) return;

                    const item = s.rows[row].dataItem;
                    if (!item) return;

                    // âœ… HTML íƒœê·¸ ì œê±° (ì›¹ì—ë””í„° ë‚´ìš©ì—ì„œ ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ)
                    const plainContent = (item.content || '').replace(/<[^>]+>/g, '');
                    const plainRemark = (item.remark || '').replace(/<[^>]+>/g, '');

                    // ìš”ì²­í˜„í™© íƒ­ì˜ ìƒì„¸ ì •ë³´ ì˜ì—­ì— ë°ì´í„° í‘œì‹œ
                    $('#reqtextf').val(plainContent);
                    $('#reqtextf2').val(plainRemark);
                    // ì²˜ë¦¬ë‚´ìš©ì€ ë³„ë„ ì¡°íšŒ í•„ìš”
                });

                // ê·¸ë¦¬ë“œ ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ - ìƒì„¸ ì¡°íšŒ ë° ì²˜ë¦¬ë“±ë¡
                this.grid1.hostElement.addEventListener('dblclick', (e) => {
                    const view = this.grid1;
                    const selected = view.selectedItems;

                    if (!selected || selected.length !== 1) {
                        Alert.alert('', 'ì„ íƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    const item = selected[0];
                    this.loadRequestDetail(item);
                });


                //ì²˜ë¦¬ë“±ë¡ í´ë¦­
                this.$btnAddNew.click(function (e) {
                    const selected = _this.grid1.selectedItems;
                    if (!selected || selected.length !== 1) {
                        Alert.alert('', 'ì²˜ë¦¬í•  ìš”ì²­ì‚¬í•­ì„ ì„ íƒí•˜ì„¸ìš”.');
                        return;
                    }
                    const item = selected[0];
                    _this.loadRequestDetail(item);
                });



            }


            searchMain(){
                let _this = this;

                let data = {
                    searchfrdate: $('#searchfrdate2').val(),
                    searchtodate: $('#searchtodate2').val(),
                    searchCompCd: $('#cboCompanyHidden2').val(),
                    searchCompnm: $('#cboCompany2').val(),
                    aspernm: $('#aspernm2').val(),
                    reqType : $('#reqType2').val(),
                    spjangcd: getSpjangcdFromSession(),
                }

                let url = _this.url + '/search';
                let fnsuccess = function (result) {
                    if (result != null && result.data) {
                        _this.viewData.sourceCollection = result.data;
                    } else {
                        _this.viewData.sourceCollection = [];
                    }
                };
                AjaxUtil.getAsyncData(url, data, fnsuccess);
            }

            loadRequestDetail(item) {
                let _this = this;
                
                if (!item || !item.id) {
                    return;
                }

                let params = {
                    asid: item.id,
                    action: 'detail'
                };

                AjaxUtil.getAsyncData(_this.url + '/detail', params, function(result) {
                    if (result && result.data) {
                        const data = result.data;
                        _this.showPlanForm(data);
                    }
                });
            }


            //ì²˜ë¦¬ë“±ë¡ íŒì—…í™œì„±í™”
            showPlanForm(data) {

                let _this = this;
                let formData = data; // í´ë¡œì €ë¥¼ ìœ„í•œ ë³€ìˆ˜ëª… ë³€ê²½
                let content = tmpl('planTemplate', formData);
                let $content = $(content);

                // íŒì—… ì—´ê¸°
                let modalContainer = new PopupDraggable('ì²˜ë¦¬ë“±ë¡');
                modalContainer.open({ width: 1100, height: 600, $content });

                // âœ… íŒì—… ë Œë”ë§ í›„ Editor ìƒì„± (ì™¸ë¶€ ìŠ¤ì½”í”„ì—ì„œ ì„ ì–¸)
                let popupEditor = null;
                setTimeout(() => {
                    const webEditEl = $content.find('#webEdit')[0];
                    if (webEditEl) {
                        popupEditor = new toastui.Editor({
                            el: webEditEl,
                            height: '290px',
                            initialEditType: 'wysiwyg',
                            previewStyle: 'vertical',
                            placeholder: 'ì²˜ë¦¬ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...',
                            toolbarItems: [
                                ['heading', 'bold', 'italic', 'strike'],
                                ['hr', 'quote'],
                                ['ul', 'ol', 'task', 'indent', 'outdent'],
                                ['table', 'link'],
                                ['code', 'codeblock']
                            ]
                        });
                        
                        // ê¸°ì¡´ ì²˜ë¦¬ë‚´ìš©ì´ ìˆìœ¼ë©´ ì„¤ì •
                        if (formData.processContent) {
                            popupEditor.setHTML(formData.processContent);
                        }
                    }
                }, 200);

                let $btnDelete = $content.find('#btnDelete');
                let $planForm = $content.find('#planForm');
                // ì €ì¥ë²„íŠ¼
                let $btnPopSave = $content.find('#btnSave');

                // ì²˜ë¦¬ì¼ì ì„¤ì • (ì˜¤ëŠ˜ ë‚ ì§œ)
                let initDateStr = new Date().toISOString().slice(0, 10);
                $content.find('#rptdate').val(initDateStr);

                // ë³¸ì‚¬ë‹´ë‹¹ ì„¤ì •
                const username = sessionStorage.getItem("username");
                if (username) {
                    $content.find('#aspernm').val(username);
                }

                // ê¸°ì¡´ ë°ì´í„° ë°”ì¸ë”©
                if (formData.id) {
                    $content.find('#id').val(formData.id);
                    $content.find('#cltnm').val(formData.title || formData.retitle || '');
                    // ìš”ì²­êµ¬ë¶„, í™”ë©´ëª… ë“±ì€ readonlyë¡œ í‘œì‹œë§Œ
                    $content.find('#asmenu').val(formData.asmenu || '');
                }

                // âœ… ì™„ë£Œ ì²¨ë¶€íŒŒì¼ ì¡´ì¬ ì‹œ í‘œì‹œ
                if (formData.fix_file && formData.fix_file.trim() !== '') {
                    // íŒŒì¼ ì¡´ì¬í•  ë•Œ
                    $content.find('#fileText')
                        .val('ì™„ë£Œì²¨ë¶€ íŒŒì¼ì¡´ì¬')
                        .css({
                            'color': '#0a7cff',     // íŒŒë€ìƒ‰ ê°•ì¡°
                            'font-weight': 'bold'   // êµµê²Œ
                        })
                        .data('filename', formData.fix_file); // âœ… ë‚˜ì¤‘ì— ë‹¤ìš´ë¡œë“œìš©ìœ¼ë¡œ íŒŒì¼ëª…ë„ ì €ì¥
                } else {
                    // íŒŒì¼ ì—†ì„ ë•Œ (ì´ˆê¸°í™”)
                    $content.find('#fileText')
                        .val('')
                        .css({ 'color': '', 'font-weight': '' })
                        .removeData('filename');
                }

                // ì§„í–‰êµ¬ë¶„ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì´ˆê¸°í™”
                AjaxUtil.fillSelectOptions($content.find('#actflag'), 'system_code', '', '1', 'recyn');
                if (formData.recyn) {
                    $content.find('#actflag').val(formData.recyn);
                }

                // ìš”ì²­êµ¬ë¶„ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ë°”ì¸ë“œ
                AjaxUtil.fillSelectOptions($content.find('#fixflag'), 'system_code', '', formData.asdv, 'asdv');
                if (formData.recyn) {
                    $content.find('#fixflag').val(formData.asdv);
                }

                // ì²˜ë¦¬ë“±ë¡ íŒì—… ì €ì¥ë²„íŠ¼ í´ë¦­
                $btnPopSave.off('click').on('click', function (e) {
                    e.preventDefault();
                    
                    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
                    const asid = $content.find('#id').val();
                    if (!asid) {
                        Alert.alert('', 'ìš”ì²­ì‚¬í•­ì„ ì„ íƒí•˜ì„¸ìš”.');
                        return;
                    }

                    const fixdate = $content.find('#rptdate').val();
                    if (!fixdate) {
                        Alert.alert('', 'ì²˜ë¦¬ì¼ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                        return;
                    }

                    Alert.confirm('', 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
                        // Toast UI Editorì—ì„œ ì²˜ë¦¬ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                        let processContent = '';
                        if (popupEditor) {
                            try {
                                processContent = popupEditor.getHTML();
                            } catch (e) {
                                console.error('Editor getHTML error:', e);
                            }
                        }
                        
                        // ì§„í–‰êµ¬ë¶„
                        const recyn = $content.find('#actflag').val() || '1';
                        const check020 = $content.find('#check020').is(':checked') ? "1" : "0";

                        const payload = {
                            fixid: formData.fixid || '',
                            asid: asid,
                            fixdate: fixdate,
                            rptdate: fixdate, // í˜¸í™˜ì„±
                            remark: processContent,
                            processContent: processContent,
                            recyn: recyn,
                            check020: check020,
                            spjangcd: getSpjangcdFromSession(),
                        };

                        console.log('Save payload:', payload);

                        // âœ… íŒŒì¼ ì²¨ë¶€ ì²˜ë¦¬
                        const fileInput = $content.find('#drawingFile')[0];
                        const file = fileInput && fileInput.files.length > 0 ? fileInput.files[0] : null;

                        if (file) {
                            let formData = new FormData();
                            formData.append('uploadFile', file);

                            AjaxUtil.postFileAsyncData(
                                '/api/request/uploadFile',
                                formData,
                                function (res) {
                                    if (res.success) {
                                        console.log('íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ:', res.data);
                                        payload.as_file = res.data;
                                        saveProcessData(payload);
                                    } else {
                                        Alert.alert('', 'íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + res.message);
                                    }
                                },
                                function (req, status, error) {
                                    console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', req.responseText);
                                    Alert.alert('ì˜¤ë¥˜', 'íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ (' + req.status + ')');
                                }
                            );
                        } else {
                            saveProcessData(payload);
                        }

                        // âœ… íŒŒì¼ ì—…ë¡œë“œ í›„ í˜¸ì¶œë˜ëŠ” ì €ì¥ í•¨ìˆ˜
                        function saveProcessData(data) {
                            AjaxUtil.postJsonData(_this.url + '/save', data, function (res) {
                                if (res.success) {
                                    Notify.success("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                                    _this.searchMain();
                                    modalContainer.close();
                                } else {
                                    Alert.alert('ì €ì¥ ì‹¤íŒ¨', res.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                                }
                            });
                        }
                    });
                });

                // ì‚­ì œ ë²„íŠ¼
                $btnDelete.click(function (e) {
                    let data = FormUtil.extractForm($planForm);

                    Alert.confirm('', 'ì „ì²´ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                        function () {
                            let id = data.head_id;
                            _this.deletePlanData(id);
                        },
                        function () {
                        }
                    );
                    modalContainer.close();

                });

            }
            showGetComp() {
                let _this = this;
                let viewdata4;
                let theGrid4;
                let selectedItem = null;

                let content = tmpl('getCompTemplate', {});
                let $content = $(content);

                let popContainer = new PopupDraggable('ê±°ë˜ì²˜ì¡°íšŒ');
                popContainer.open({ width: 800, height: 500, $content });

                let $searchName = $content.find('#searchName');
                let $searchCode = $content.find('#searchCode');
                let $btnSearch = $content.find('#btnSubjectSearch');


                // ì‚¬ë²ˆ ì¡°íšŒ í•¨ìˆ˜
                function fetchPersonList() {
                    let searchCode = $searchCode.val();
                    let searchName = $searchName.val();

                    $.ajax({
                        url: '/api/request/getComp',
                        type: 'GET',
                        data: {
                            searchCode: searchCode,
                            searchName: searchName,
                            spjangcd: sessionStorage.getItem('spjangcd')
                        },
                        async: false,
                        success: function (res) {
                            let data2 = res.data || [];

                            viewdata4 = new wijmo.collections.CollectionView(data2);

                            if (theGrid4) {
                                theGrid4.itemsSource = viewdata4;
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.error('Error fetching person data:', textStatus, errorThrown);
                        }
                    });
                }

                // ê·¸ë¦¬ë“œ ë¨¼ì € ìƒì„±
                theGrid4 = new wijmo.grid.FlexGrid('#comp-grid', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    columns: [
                        { binding: 'Code', header: 'ì—…ì²´ì½”ë“œ', width: 100, align: 'center' },
                        { binding: 'BusinessNumber', header: 'ì‚¬ì—…ìë²ˆí˜¸', width: 100, align: 'center' },
                        { binding: 'Name', header: 'ê±°ë˜ì²˜ëª…', width: '*', align: 'center' },
                        { binding: 'OurManager', header: 'ë‹´ë‹¹ìëª…', width: 150, align: 'center' },
                    ],
                    isReadOnly: true,
                    itemsSource: null
                });

                theGrid4.rowHeaders.columns.splice(0, 1);


                fetchPersonList();


                $btnSearch.click(() => {
                    fetchPersonList();
                });


                $searchCode.add($searchName).on('keydown', function (e) {
                    if (e.keyCode === 13) {
                        fetchPersonList();
                    }
                });

                theGrid4.selectionChanged.addHandler((s, e) => {
                    selectedItem = s.collectionView.currentItem;
                });

                $content.find('#btnAccountSave').click(() => {
                    if (selectedItem) {
                        console.log('selectedItem : ', selectedItem)
                        $('#cboCompany2').val(selectedItem.Name);
                        $('#cboCompanyHidden2').val(selectedItem.Code);
                        popContainer.close();
                    }/* else {
                        Alert.alert('', 'ì‚¬ë²ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    }*/
                });

                theGrid4.hostElement.addEventListener('dblclick', function (e) {
                    let items = theGrid4.selectedItems;
                    if (items.length === 0) {
                        return false;
                    }
                    const selectedItem = items[0];
                    if (selectedItem) {
                        console.log('selectedItem : ', selectedItem)
                        $('#cboCompany2').val(selectedItem.Name);
                        $('#cboCompanyHidden2').val(selectedItem.Code);
                        popContainer.close();
                    }
                    popContainer.close();
                });

            }
        }

        let page = null;


        $(document).ready(function (e) {
            page = new SalesList();
            // âœ… ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œê·¸ì¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
            // const userId = sessionStorage.getItem('userid');     // ì‚¬ì—…ìë²ˆí˜¸
            // const userName = sessionStorage.getItem('username'); // ì—…ì²´ëª…
            //
            // // âœ… ê°’ ì¡´ì¬ ì‹œ ìë™ ë°”ì¸ë”©
            // if (userId) {
            //     $('#cboCompanyHidden2').val(userId);  // ê±°ë˜ì²˜ ì½”ë“œ(ì‚¬ì—…ìë²ˆí˜¸)
            // }
            // if (userName) {
            //     $('#cboCompany2').val(userName);      // ì—…ì²´ëª…
            // }

            // ì¡°íšŒ ë²„íŠ¼
            $('#btnSearch2').click(function(){
                page.searchMain();
            });

            // íŒŒì¼ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ, íŒŒì¼ ì„ íƒì°½ ì‹¤í–‰
            $(document).on('click', '#btnFile, #fileText', function() {
                $('#drawingFile').click(); // âœ… ì´ í•œ ì¤„ì´ í•µì‹¬
            });

            // ì—…ì²´ëª… input í´ë¦­ì‹œ ì—…ì²´ ê²€ìƒ‰ íŒì—… í™œì„±í™”
            $('#cboCompany2').click(function (e) {
                page.showGetComp();
            });

            page.searchMain();


        })

        // ì™„ë£Œ íŒŒì¼ ì„ íƒ ì™„ë£Œí›„ í™”ë©´ì— í‘œì‹œ
        $('#drawingFile').on('change', function() {
            const file = this.files[0];
            // íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš°
            if (!file) return;

            // íŒŒì¼ í™•ì¥ì ê²€ì‚¬
            const fileName = file.name.toLowerCase();

            // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ

            // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™” (ë°”ì¸ë”© í•´ì œ)

            Alert.alert('', 'ì„ íƒëœ íŒŒì¼: ' + file.name);
            document.getElementById('fileText').value = file.name;
        });

        // ì ‘ìˆ˜ì²˜ë¦¬ í´ë¦­ ì´ë²¤íŠ¸
        $('#btnReceipt').on('click', function () {
            const grid = wijmo.Control.getControl('#theGrid_reqList');
            const selectedItem = grid.selectedItems[0];

            // ì„ íƒ í™•ì¸
            if (!selectedItem) {
                Alert.alert('', 'í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const asid = selectedItem.id;

            Alert.confirm('', 'ì„ íƒí•œ ìš”ì²­ì„ ì ‘ìˆ˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
                const payload = { asid: asid };

                // âœ… CSRF ìë™ ì²˜ë¦¬ë˜ëŠ” AjaxUtil ì‚¬ìš©
                AjaxUtil.postJsonData(page.url + '/receive', payload, function (res) {
                    if (res.success) {
                        Alert.alert('', 'ì ‘ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        page.searchMain(); // âœ… ê·¸ë¦¬ë“œ ê°±ì‹ 
                    } else {
                        Alert.alert('', 'ì‹¤íŒ¨: ' + (res.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                });
            });
        });

        // ì™„ë£Œì²¨ë¶€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
        $(document).on('click', '#download', function () {
            const grid = wijmo.Control.getControl('#theGrid_reqList');
            const selectedItem = grid.selectedItems[0];

            if (!selectedItem) {
                Alert.alert('', 'ë‹¤ìš´ë¡œë“œí•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            const fileName = selectedItem.fix_file; // âœ… ì¡°íšŒ ê²°ê³¼ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´

            if (!fileName || fileName.trim() === '') {
                Alert.alert('', 'ì™„ë£Œ ì²¨ë¶€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            window.open('/api/request_current/downFile?fileName=' + encodeURIComponent(fileName), '_blank');
        });



        $(document).on('change', '#drawingFile', function() {
            const file = this.files[0];
            if (!file) return;
            $('#fileText').val(file.name);
        });

    </script>

</th:block>
</html>