<html layout:decorate="~{layout_page}">
<head>
    <style>
        #matListTb input, #matListTb textarea {
            width: 100px;
            height: 40px;
        }

        input[type="date"][readonly] {
            background-color: #EDEFF5;
        }
        /* ============================================
   FlexGrid ì…€ ê¸°ë³¸ í°íŠ¸ & íŒ¨ë”© í™•ëŒ€ (UPGRADE)
   ============================================ */
        #workReportPage .wj-flexgrid .wj-cell {
            font-size: 14px !important;       /* 13 â†’ 14 */
            padding: 8px 10px !important;     /* 6â†’8, 8â†’10 */
        }

        /* ============================================
           ê·¸ë£¹í–‰ Row ì „ì²´ ë†’ì´ ì¦ê°€ (í•µì‹¬!)
           ============================================ */
        #workReportPage .wj-flexgrid .wj-row[aria-level] {
            height: 30px !important;          /* 26 â†’ 30 */
        }

        /* ê·¸ë£¹ ì…€ ë†’ì´ ë§ì¶¤ */
        #workReportPage .wj-flexgrid .wj-cell.wj-group {
            display: flex !important;
            align-items: center !important;
            height: 35px !important;          /* 30 â†’ 32 */
            line-height: 32px !important;
            padding: 0 10px !important;       /* ì¢Œìš° íŒ¨ë”© ì‚´ì§ ì¦ê°€ */
            font-weight: 500;
            font-size: 14px !important;       /* ê·¸ë£¹ì…€ í°íŠ¸ë„ ê°™ì´ ì¦ê°€ */
        }

        /* ============================================
           ê·¸ë£¹ í™”ì‚´í‘œ ë²„íŠ¼ í¬ê¸° (ì¡°ê¸ˆ í™•ëŒ€)
           ============================================ */
        #workReportPage .wj-flexgrid .wj-group .wj-btn-glyph {
            height: 20px !important;          /* 18 â†’ 20 */
            width: 20px !important;           /* 18 â†’ 20 */
            margin-right: 8px !important;     /* 6 â†’ 8 */
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* ì•„ì´ì½˜ ë³´ì • */
        #workReportPage .wj-flexgrid .wj-group .wj-btn-glyph .wj-glyph-right,
        #workReportPage .wj-flexgrid .wj-group .wj-btn-glyph .wj-glyph-down {
            margin: 0 !important;
            top: 0 !important;
        }

        /* ê·¸ë£¹ íŒ¨ë„ ì „ì²´ */
        #workReportPage #theGridPanel {
            height: 48px;               /* ê¸°ë³¸ì€ 45~55px â†’ ì¤„ì„ */
            padding: 4px 8px !important;
            font-size: 12px !important; /* FlexGridì™€ ë™ì¼í•˜ê²Œ */
            display: flex;
            align-items: center;        /* í…ìŠ¤íŠ¸ ë° ì•„ì´ì½˜ ê°€ìš´ë° ì •ë ¬ */
            border: 1px solid #dcdcdc;
            border-bottom: none;        /* ê·¸ë¦¬ë“œì™€ ë¶™ì—¬ë³´ì´ë„ë¡ */
            background-color: #f8f8f8;  /* ê·¸ë£¹íŒ¨ë„ ëŠë‚Œ ìœ ì§€ */
        }

        /* Panel ë‚´ë¶€ placeholder í…ìŠ¤íŠ¸ */
        #workReportPage #theGridPanel .wj-grouppanel-placeholder {
            font-size: 12px !important;
            color: #777 !important;
        }

        /* Panel ë‚´ë¶€ field chip (ê·¸ë£¹ ê¸°ì¤€ í•„ë“œ) */
        #workReportPage #theGridPanel .wj-grouppanel-field {
            padding: 2px 6px !important;
            font-size: 12px !important;
            margin-right: 5px !important;
            height: 20px !important;
            display: flex;
            align-items: center;
        }

        #workReportPage #theGridPanel .wj-grouppanel .wj-groupmarker {
            padding: 4px 6px 3px 6px;
        }



    </style>
</head>
<th:block layout:fragment="content">

    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>ì—…ë¬´ì¼ì§€ í˜„í™©</h2>
                <a title="ë¶ë§ˆí¬" class="bookmark toggle">
                    ë‚´ ë©”ë‰´
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                <li>ìœ ì§€ë³´ìˆ˜</li>
                <li>ì—…ë¬´ì¼ì§€ í˜„í™©</li>
            </ul>
        </div>

        <section class="section">
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            <label for="cboDateKind">
                                êµ¬ë¶„<span class="eq"></span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <select id="cboDateKind" name="cboDateKind">
                                    <option value="selectDate" selected>ê¸°ê°„</option>
                                    <option value="week">ì£¼ê°„</option>
                                    <option value="month">ì›”ê°„</option>
                                </select>
                                <div id="extraSelectBox" style="display:inline-block; margin-left: 10px;"></div>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            ì¡°íšŒê¸°ê°„<span class="eq">*</span>
                        </dt>
                        <dd>
                            <ul class="date-box">
                                <li>
                                    <input type="date" id="srchStartDt" name="srchStartDt">
                                    <label for="srchStartDt" class="hide">ì‹œì‘ì¼</label>
                                </li>
                                <li>
                                    <input type="date" id="srchEndDt" name="srchEndDt">
                                    <label for="srchEndDt" class="hide">ì¢…ë£Œì¼</label>
                                </li>
                            </ul>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            ì‚¬ì›ëª…
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input style="width:180px;"
                                       id="txtName"
                                       name="txtName"
                                       th:value="${session.groupid == 2} ? ${session.username} : ''"
                                       th:readonly="${session.groupid == 2}">
                            </div>
                        </dd>
                    </dl>

                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="ì¡°íšŒ" id="btnSearch">
                                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                    ì¡°íšŒ
                                </a>
                            </li>
                        </dd>
                    </dl>
                </div>
                <div class="button-wrap">
                    <ul>
                        <li>
                            <a class="btn btn-excell" title="ë“±ë¡" id="btnAddNew">
                                <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜">
                                ì¼ì§€ë“±ë¡
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="container-fluid"  id="workReportPage">
                <div id="theGridPanel"></div>
                <div id="theGrid" style="height: calc(100vh - 390px);"></div>
            </div>
            <div class="container-fluid" style="margin-top: 10px;">
                <div class="search-wrap" style="display: flex; gap: 20px;">

                    <dl style="flex: 2;">
                        <dt>
                            <label for="rptremark">
                                ì—…ë¬´ë‚´ìš©<span class="eq"></span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <textarea id="rptremark" style="height:150px; width:100%; box-sizing:border-box;" readonly></textarea>
                            </div>
                        </dd>
                    </dl>

                    <dl style="flex: 2;">
                        <dt>
                            <label for="remark">
                                íŠ¹ì´ì‚¬í•­<span class="eq"></span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <textarea id="remark" style="height:150px; width:100%; box-sizing:border-box;" readonly></textarea>
                            </div>
                        </dd>
                    </dl>

                    <dl style="flex: 1;">
                        <dt>
                            <label for="etcremark">
                                ì—°ì¥/íŠ¹ê·¼ì—…ë¬´<span class="eq"></span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <textarea id="etcremark" style="height:150px; width:100%; box-sizing:border-box;" readonly></textarea>
                            </div>
                        </dd>
                    </dl>

                </div>
            </div>


        </section>

    </div>
    <script type="text/x-tmpl" id="planTemplate">
        <style>
            /* ì•„ì´í…œ í…Œì´ë¸” ì „ì²´ ì„¤ì • */
            .item-table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed;
                margin-top: 10px;
            }

            /* í—¤ë” ì…€ ìŠ¤íƒ€ì¼ */
            .item-table th {
                background-color: #EDEFF5;
                text-align: center;
                font-weight: bold;
                padding: 8px;
                border: 1px solid #ccc;
            }

            /* ë°”ë”” ì…€ ìŠ¤íƒ€ì¼ */
            .item-table td {
                padding: 6px;
                text-align: center;
                border: 1px solid #ccc;
            }

            /* ì…ë ¥ í•„ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
            .item-table input {
                width: 100%;
                box-sizing: border-box;
                padding: 4px;
            }

            /* í’ˆëª© & ë¹„ê³  ì™¼ìª½ ì •ë ¬ */
            .item-table td:first-child,
            .item-table td:nth-child(6) {
                text-align: left;
            }

            /* ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
            .item-table .btn.in_btn {
                display: inline-flex;
                justify-content: center;
                align-items: center;
                width: 32px;
                height: 32px;
                border-radius: 4px;
                padding: 0;
                border: 1px solid #B3B3B3;
                background-color: #fff;
                cursor: pointer;
                transition: background-color 0.2s;
                line-height: 0;
            }

            /* + ë²„íŠ¼ ì „ìš© ìŠ¤íƒ€ì¼ */
            .item-table .btn.in_btn.plus img {
                width: 10px;
                height: 10px;
                display: block;
            }

            /* ê³µí†µ ì•„ì´ì½˜ ë²„íŠ¼ ì´ë¯¸ì§€ (ì‚­ì œ, ê²€ìƒ‰ í¬í•¨) */
            .item-table .btn.in_btn img {
                width: 12px;
                height: 12px;
                display: block;
                margin-right: 5px;
            }

            /* ëª¨ë‹¬ êµ¬ì¡° */
            .content_wrap.popup {
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
            }

            .table-wrap {
                flex: 1;
                overflow-y: auto;
                padding-right: 5px;
                width: 100%;
            }

            /* í…Œì´ë¸” ì „ì²´ ë°˜ì‘í˜• */
            .write-table,
            .item-table {
                width: 100%;
                table-layout: fixed;
                border-collapse: collapse;
            }

            /* colgroup ì§€ì •ëœ th ì—´ ì¢ê²Œ ì„¤ì • */
            .write-table col.col-th {
                width: 80px !important;
            }

            .write-table col.col-td {
                width: auto;
            }

            .write-table input,
            .write-table select,
            .write-table textarea,
            .item-table input,
            .item-table select,
            .item-table textarea {
                width: 100%;
                box-sizing: border-box;
            }

            /* ê¸°ë³¸ ì…€ ìŠ¤íƒ€ì¼ */
            .write-table th,
            .write-table td {
                border: 1px solid #ccc;
                padding: 6px;
            }

            /* th í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
            .write-table th {
                white-space: nowrap;
                text-align: center;
            }

            .popup-button {
                flex-shrink: 0;
                padding: 10px;
                background: #fff;
                border-top: 1px solid #ddd;
            }
            .clt-wrapper {
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .clt-wrapper #cltnm {
                flex: 1;
            }

            .clt-wrapper #btnCompanySearch {
                flex-shrink: 0;
                display: inline-flex;
                justify-content: center;
                align-items: center;
                width: 32px;
                height: 32px;
                border: 1px solid #B3B3B3;
                border-radius: 4px;
                background-color: #fff;
            }

            .clt-wrapper #btnCompanySearch img {
                width: 16px;
                height: 16px;
            }

        </style>

        <div class="content_wrap popup">
            <div class="table-wrap">
                <form id="reportForm">
                    <table class="write-table">
                        <colgroup>
                            <col style="width:80px">
                            <col style="width:14%">

                            <col style="width:80px">
                            <col style="width:48%">

                            <col style="width:80px">
                            <col style="width:14%">
                        </colgroup>

                        <caption>ë“±ë¡ í…Œì´ë¸”</caption>
                        <input type="hidden" id="id" name="id">

                        <tbody>
                            <tr>
                                <th><label for="rptdate">ë‚ ì§œ</label></th>
                                <td>
                                    <input class="form-control2" type="date" id="rptdate" name="rptdate" style="min-width:135px;">
                                </td>
                                <th><label for="datetype">ì£¼ì°¨</label></th>
                                <td>
                                    <div class="input-group" style="display:flex; align-items:center; gap:5px;">
                                        <!-- datetype ìˆ¨ê¹€ -->
                                        <select id="datetype" name="datetype" style="display:none;">
                                            <option value="week">ì£¼ê°„</option>
                                        </select>
                                        <!-- ì‹œì‘ì¼ ì¢…ë£Œì¼ -->
                                        <input type="date" id="stdate" name="stdate" style="max-width:120px;" readonly>
                                        ~
                                        <input type="date" id="eddate" name="eddate" style="max-width:120px;" readonly>
                                    </div>
                                </td>

                                <th><label for="fixperid">ë³¸ì‚¬ë‹´ë‹¹</label></th>
                                <td>
                                    <input type="hidden" id="fixperid" name="fixperid">
                                    <input type="text" id="fixpernm" name="fixpernm" readonly>
                                </td>
                            </tr>

                            <tr>
                                <th><label for="cltnm">ì—…ì²´ëª…</label></th>
                                <td colspan="3">
                                    <div class="clt-wrapper">
                                        <input class="form-control2" type="hidden" id="cltcd" name="cltcd">
                                        <input class="form-control2" type="text" id="cltnm" name="cltnm"
                                            placeholder="ì—”í„° ëˆŒëŸ¬ì„œ ê²€ìƒ‰ ë˜ëŠ” ì…ë ¥ í›„ ì—”í„°">

                                        <a class="btn" title="ê²€ìƒ‰" id="btnCompanySearch">
                                            <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                        </a>
                                    </div>
                                </td>
                                <th><label for="fixflag">ì—…ë¬´êµ¬ë¶„</label></th>
                                <td>
                                    <select class="form-control2" id="fixflag" name="fixflag"></select>
                                </td>
                            </tr>

                            <tr>
                                <th><label for="asmenu">í™”ë©´ëª…</label></th>
                                <td colspan="3">
                                    <input class="form-control2" type="text" id="asmenu" name="asmenu">
                                </td>
                                <th><label for="actflag">ê·¼ë¬´êµ¬ë¶„</label></th>
                                <td>
                                    <select class="form-control2" id="actflag" name="actflag"></select>
                                </td>
                            </tr>

                            <tr>
                                <th><label for="asdv">êµ¬ë¶„</label></th>
                                <td>
                                    <select class="form-control2" type="text" id="asdv" name="asdv"></select>
                                </td>
                                <th><label for="recyn">ì§„í–‰ìƒíƒœ</label></th>
                                <td colspan="3">
                                    <select class="form-control2" id="recyn" name="recyn" style="max-width:140px;"></select>
                                </td>
                            </tr>

                            <tr>
                                <th><label for="rptremark">ì—…ë¬´ë‚´ìš©</label></th>
                                <td colspan="5">
                                    <textarea id="rptremark" name="rptremark" style="height:110px;"></textarea>
                                </td>
                            </tr>

                            <tr>
                                <th><label for="etcremark">ì•¼ê·¼/íŠ¹ê·¼ <br>ì—…ë¬´</label></th>
                                <td colspan="5">
                                    <textarea id="etcremark" name="etcremark" style="height:70px;"></textarea>
                                </td>
                            </tr>

                            <tr>
                                <th><label for="remark">íŠ¹ì´ì‚¬í•­</label></th>
                                <td colspan="5">
                                    <textarea id="remark" name="remark" style="height:70px;"></textarea>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </form>
            </div>

            <div class="popup-button" style="margin-top:0px;">
                <button type="button" class="btn-popup y_write_auth" id="btnPopSave">ì €ì¥</button>
                <button type="button" class="btn-popup y_write_auth" id="btnEdit" style="display:none;">ìˆ˜ì •</button>
                <button type="button" class="btn-popup" id="modal-close-button">ë‹«ê¸°</button>
                <button type="button" class="btn-popup y_write_auth" id="btnDelete" style="display:none;">ì‚­ì œ</button>
            </div>
        </div>
    </script>

</th:block>

<th:block layout:fragment="scripts">
    <th:block th:replace="/common/popup_company_all :: popup_company_all"></th:block>
    <script type="text/javascript">

        class WorkReportPage {
            constructor() {
                this.url = '/api/report/work_report';
                this.grid = null;
                this.$btnEdit = $('#btnEdit');
                this.$btnAddNew = $('#btnAddNew');
                this.viewData = new wijmo.collections.CollectionView();
                this.init();

            }

            resetPlanListIndex() {
                this.planListIndex = 0;
            }

            nextPlanListIndex() {
                return this.planListIndex++;
            }

            init() {
                let _this = this;
                this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (s, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                        if (e.panel.cellType === wijmo.grid.CellType.Cell &&
                            s.rows[e.row] instanceof wijmo.grid.GroupRow) {

                            // í˜„ì¬ HTML ì˜ˆ:  ì£¼ì°¨: <b>2025ë…„ 48ì£¼ì°¨</b> (3 items)
                            let html = e.cell.innerHTML;

                            // " (ìˆ«ì items)" ë¥¼ " (ìˆ«ì ê±´)" ìœ¼ë¡œ ì¹˜í™˜
                            html = html.replace(/\((\d+)\s+items\)/, '($1 ê±´)');

                            e.cell.innerHTML = html;
                        }
                    },
                    columns: [
                        {binding: 'id', visible:false},
                        {binding: 'rptdate', header: 'ì‘ì„±ì¼ì', width: 120, align: 'center'},
                        {binding: 'rptweek', header: 'ì£¼ì°¨', width: 140, align: 'center'},
                        {binding: 'fixflag_nm', header: 'ì—…ë¬´êµ¬ë¶„', width: 100, align: 'center'},
                        {binding: 'fixpernm', header: 'ì‚¬ì›ëª…', width: 120, align: 'center'},
                        {binding: 'cltnm', header: 'ì—…ì²´ëª…', width: 150, align: 'center'},
                        {binding: 'asmenu', header: 'í™”ë©´ëª…', width: 200, align: 'left'},
                        {binding: 'rptremark', header: 'ì—…ë¬´ë‚´ìš©', width: 300, align: 'left'},
                        {binding: 'recyn_nm', header: 'ì§„í–‰ìƒíƒœ', width: 100, align: 'center'},
                        {binding: 'asdv_nm', header: 'ê·¼ë¬´êµ¬ë¶„', width: 100, align: 'center'},
                        {binding: 'inputdate', header: 'ì…ë ¥ì¼ì', width: 150, align: 'center'},
                    ],

                    itemsSource: this.viewData
                });

                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = 'ì—…ë¬´ë³´ê³  ë‚´ì—­';

                // -----------------------------
                // 2) GroupPanel ìƒì„±
                // -----------------------------
                this.groupPanel = new wijmo.grid.grouppanel.GroupPanel('#theGridPanel', {
                    grid: this.grid,
                    placeholder: 'ì—¬ê¸°ì— í•„ë“œë¥¼ ëŒì–´ì„œ ê·¸ë£¹í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
                });

                // -----------------------------
                // 3) ê¸°ë³¸ ê·¸ë£¹ ì„¤ì •
                // -----------------------------
                this.viewData.groupDescriptions.clear();

                // 1ë‹¨ê³„ ê·¸ë£¹: ì£¼ì°¨
                this.viewData.groupDescriptions.push(
                    new wijmo.collections.PropertyGroupDescription('rptweek')
                );

                // 2ë‹¨ê³„ ê·¸ë£¹: ì‚¬ì›ëª…
                this.viewData.groupDescriptions.push(
                    new wijmo.collections.PropertyGroupDescription('fixpernm')
                );


                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = 'ì—…ë¬´ì¼ì§€ ë‚´ì—­';

                this.grid.selectionChanged.addHandler((s, e) => {
                    const row = s.selection.row;
                    if (row < 0) return;

                    const item = s.rows[row].dataItem;
                    if (!item) return;

                    $("#rptremark").val(item.rptremark || "");
                    $("#etcremark").val(item.etcremark || "");
                    $("#remark").val(item.remark || "");
                });


                // ğŸ”µ FlexGrid ë”ë¸”í´ë¦­ â†’ ìƒì„¸ ì¡°íšŒ & ìˆ˜ì • íŒì—… ì—´ê¸°
                this.grid.hostElement.addEventListener('dblclick', (e) => {
                    const view = this.grid;                  // grid ì°¸ì¡°
                    const selected = view.selectedItems;     // ì„ íƒëœ í–‰ë“¤

                    // ì„ íƒëœ í–‰ì´ ì—†ìœ¼ë©´ ì¤‘ë‹¨
                    if (!selected || selected.length !== 1) {
                        Alert.alert('', 'ì„ íƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    const item = selected[0];

                    // ğŸ”µ ë’¤ì—ì„œ ì¬ì„ íƒí•˜ê¸° ìœ„í•´ ID ì €ì¥
                    window.selectedGridId = item.id;

                    // ğŸ”µ ìƒì„¸ ì¡°íšŒ ìš”ì²­
                    const params = {
                        id: item.id,
                        action: 'detail'
                    };

                    AjaxUtil.getAsyncData(this.url + '/detail', params, (result) => {
                        if (!result || !result.data) {
                            Alert.alert('', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                            return;
                        }

                        result.data.mode = 'edit';       // ìˆ˜ì • ëª¨ë“œ ì§€ì •
                        this.showReportForm(result.data); // íŒì—… ì—´ê¸°
                    });
                });

                //ìˆ˜ì£¼ë“±ë¡ í´ë¦­
                this.$btnAddNew.click(function (e) {
                    let defaultData = {
                        id: '',
                        mode: 'new'
                    };
                    _this.showReportForm(defaultData);
                });

                // ì—”í„°í‚¤ ê²€ìƒ‰
                $('#keyword').on('keypress', function (e) {
                    if (e.keyCode === 13) {
                        _this.searchMainData();
                    }
                });
            }

            showReportForm(data) {

                let _this = this;
                let content = tmpl('planTemplate', data);
                let $content = $(content);
                let $btnPopSave = $content.find('#btnPopSave');
                let $btnEdit = $content.find('#btnEdit');
                let $btnDelete = $content.find('#btnDelete');
                let $reportForm = $content.find('#reportForm');
                $content.find('#datetype').val('week').hide();

                let modalContainer = null;
                if (data.mode === 'new') {
                    modalContainer = new PopupDraggable('ë“±ë¡');
                    $btnPopSave.show();
                    $btnEdit.hide();
                    $btnDelete.hide();
                } else {
                    modalContainer = new PopupDraggable('ìˆ˜ì •');
                    $btnPopSave.hide();
                    $btnEdit.show();
                    $btnDelete.show();
                }
                modalContainer.open({width: 1100, height: 600, $content});

                let initDateStr = "";

                if (data.mode === 'new') {
                    // ì‹ ê·œ â†’ ì˜¤ëŠ˜ ë‚ ì§œ
                    initDateStr = new Date().toISOString().slice(0, 10);
                    const username = sessionStorage.getItem("username");
                    const userid = sessionStorage.getItem("userid");
                    $content.find('#fixperid').val(userid);
                    // ê°’ì´ ìˆìœ¼ë©´ fixperid ìë™ ì…ë ¥
                    if (username) {
                        $content.find('#fixpernm').val(username);
                    }
                } else {
                    // ìˆ˜ì • â†’ ê¸°ì¡´ ë‚ ì§œ
                    initDateStr = data.rptdate;
                }

                // ì…ë ¥ì°½ì— ë„£ìŒ
                $content.find('#rptdate').val(initDateStr);

                // stdateì—ë„ ê¸°ì¤€ ì„¤ì •
                $content.find('#stdate').val(initDateStr);

                AjaxUtil.fillSelectOptions($content.find('#fixflag'), 'system_code', '', '', 'fixflag');
                AjaxUtil.fillSelectOptions($content.find('#actflag'), 'system_code', '', '3', 'actflag');
                if (data.actflag) {
                    $content.find('#actflag').val(data.actflag);
                }

                AjaxUtil.fillSelectOptions($content.find('#recyn'), 'system_code', '', '1', 'recyn');
                if (data.recyn) {
                    $content.find('#recyn').val(data.recyn);
                }

                // asdv: dataì— ê°’ ì—†ìœ¼ë©´ new
                AjaxUtil.fillSelectOptions($content.find('#asdv'), 'system_code', '', '4', 'asdv');
                if (data.asdv) {
                    $content.find('#asdv').val(data.asdv);
                }

                // -----------------------
                // 2) week ê³„ì‚° ë¡œì§ ì‹¤í–‰
                // -----------------------
                initPopupDateKindHandler($content);

                // datetype ê°•ì œ íŠ¸ë¦¬ê±° (week ë¡œì§ ì‹¤í–‰)
                $content.find('#datetype').trigger('change');


                // -----------------------
                // 3) ë‚ ì§œ ë³€ê²½ ì‹œ ì£¼ê°„ ìë™ ì¬ê³„ì‚°
                // -----------------------
                $content.find('#rptdate').on('change', function () {
                    let dateStr = $(this).val();

                    // ê¸°ì¤€ ë‚ ì§œë§Œ ë³€ê²½ë˜ì—ˆìœ¼ë‹ˆ, ê·¸ëƒ¥ ë‹¤ì‹œ week ê³„ì‚°
                    $content.find('#datetype').trigger('change');
                });

                // -----------------------
                // 4) ê¸°ì¡´ ë°ì´í„° ë°”ì¸ë”© (ìˆ˜ì • ëª¨ë“œ)
                // -----------------------
                setTimeout(() => {
                    FormUtil.BindDataForm(data, $reportForm);
                }, 100);

                $content.find('#cltnm').on('keydown', function (e) {
                    if (e.key !== 'Enter' && e.keyCode !== 13) return;
                    e.preventDefault();
                    _this.searchCompany($content);
                });

                $content.find('#btnCompanySearch').on('click', function () {
                    _this.searchCompany($content);
                });

                $content.find('#cltnm').on('input', function () {
                    $content.find('#cltcd').val('');
                });

                // ìˆ˜ì£¼ë“±ë¡ íŒì—… ì €ì¥ë²„íŠ¼ í´ë¦­
                $btnPopSave.click(function (e) {

                    let data = FormUtil.extractForm($reportForm);

                    Alert.confirm('', 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {

                        AjaxUtil.postJsonData(_this.url + '/save', data, function (res) {
                            if (res.success) {
                                Notify.success("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                                _this.searchMainData();
                                $content.find('#cltcd').val('');
                                $content.find('#cltnm').val('');
                                $content.find('#asmenu').val('');
                                $content.find('#rptremark').val('');
                                $content.find('#etcremark').val('');
                                $content.find('#remark').val('');
                            } else {
                                Alert.alert('ì €ì¥ ì‹¤íŒ¨', res.message || 'ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                            }
                        });

                    });
                });

                $btnEdit.click(function (e) {

                    let data = FormUtil.extractForm($reportForm);

                    Alert.confirm('', 'ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {

                        AjaxUtil.postJsonData(_this.url + '/save', data, function (res) {
                            if (res.success) {
                                Notify.success("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                                _this.searchMainData();

                            } else {
                                Alert.alert('ìˆ˜ì • ì‹¤íŒ¨', res.message || 'ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                            }
                        });

                    });
                    modalContainer.close();
                });


                // ì‚­ì œ ë²„íŠ¼
                $btnDelete.click(function (e) {
                    let data = FormUtil.extractForm($reportForm);

                    Alert.confirm('', 'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                        function () {
                            let id = data.id;
                            _this.deleteReportData(id);
                            $("#rptremark").val("");
                            $("#etcremark").val("");
                            $("#remark").val("");
                        },
                        function () {
                        }
                    );
                    modalContainer.close();

                });

            }

            searchCompany($content) {
                const keyword = $content.find('#cltnm').val().trim();
                const poppage = new PopCompComponentAll();

                const searchcallback = function (item) {
                    console.log('item', item);
                    $content.find('#cltnm').val(item.compname);
                    $content.find('#cltcd').val(item.id);
                };

                if (!keyword) {
                    poppage.focusAfterClose = $content.find('#cltnm')[0];
                    poppage.show(searchcallback);
                    return;
                }

                const result = AjaxUtil.getSyncData('/api/popup/search_Comp_all', {
                    compCode: '',
                    compName: keyword,
                    business_number: ''
                });
                const rows = result?.data || [];

                if (rows.length === 1) {
                    searchcallback(rows[0]);
                } else {
                    poppage.show(searchcallback);
                    setTimeout(() => {
                        poppage.$compName.val(keyword);
                        poppage.$btnCompSearch.trigger('click');
                    }, 50);
                }
            }

            deleteReportData(id) {
                let _this = this;
                let url = _this.url + '/delete';
                let data = {'id': id}
                let fnsuccess = function (res) {
                    if (res.success) {
                        Notify.success('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        _this.searchMainData();
                    } else {
                        Alert.alert('', res.message);
                    }
                };

                AjaxUtil.postAsyncData(url, data, fnsuccess);
            }

            searchMainData() {
                let _this = this;
                let start = $('#srchStartDt').val();
                let end = $('#srchEndDt').val();
                let txtName = $('#txtName').val();
                let url = this.url + '/read';

                let data = {
                    'start': start,
                    'end': end,
                    'txtName': txtName,
                    'action': 'read'
                };

                let fnsuccess = function (result) {
                    if (result != null) {
                        _this.viewData.sourceCollection = result.data;

                        setTimeout(() => {
                            _this.grid.collapseGroupsToLevel(0);
                        }, 10);

                        if (window.selectedGridId) {
                            // GridUtil.selectRowById(_this.grid, window.selectedGridId);
                            GridUtil.selectRowById(_this.grid, window.selectedGridId, {idField: 'id'});
                            window.selectedGridId = null;
                        }
                    }
                };
                AjaxUtil.getAsyncData(url, data, fnsuccess);

            }
        }

        // íŒì—… ë‚ ì§œ ê³„ì‚° ë¡œì§
        function initPopupDateKindHandler($content) {
            const $datetype = $content.find('#datetype');
            const $extraSelectBox = $('<span id="extraSelectBox"></span>');
            const $stdate = $content.find('#stdate');
            const $eddate = $content.find('#eddate');
            const $rptdate = $content.find('#rptdate'); // âœ… ì¶”ê°€

            $datetype.after($extraSelectBox);

            $datetype.on('change', function () {
                const type = $(this).val();
                $extraSelectBox.empty();

                // âœ… ë¨¼ì € ê¸°ì¤€ ë‚ ì§œë¥¼ êµ¬í•œë‹¤ (rptdate â†’ stdate ìˆœ)
                const rptdateStr = $rptdate.val();   // ex: "2025-08-01"
                const stdateStr  = $stdate.val();    // í˜¹ì‹œ ì´ë¯¸ ê°’ì´ ìˆë‹¤ë©´
                const baseStr    = rptdateStr || stdateStr;
                const now        = new Date();
                const targetDate = baseStr ? parseDate(baseStr) : now;

                // ê·¸ ë‹¤ìŒì— ì´ˆê¸°í™”
                $stdate.prop('readOnly', false);
                $eddate.prop('readOnly', false);

                if (type === 'week') {
                    const $weekSelect = $('<select id="popupWeekSelector" name="popupWeekSelector" style="min-width: 140px;"></select>');

                    const year = targetDate.getFullYear();
                    const currentWeek = getISOWeekNumber(targetDate);

                    for (let i = 1; i <= 52; i++) {
                        const value = `${year}ë…„ ${i}ì£¼ì°¨`;
                        const text = `${year}ë…„ ${i}ì£¼ì°¨`;
                        const $option = $(`<option value="${value}">${text}</option>`);
                        if (i === currentWeek) {
                            $option.prop("selected", true); // âœ… ê¸°ì¤€ ë‚ ì§œê°€ ì†í•œ ì£¼ì°¨ ì„ íƒ
                        }
                        $weekSelect.append($option);
                    }

                    $weekSelect.on('change', function () {
                        const val = $(this).val(); // ì˜ˆ: "2025ë…„ 11ì£¼ì°¨"

                        const y = parseInt(val.split("ë…„")[0].trim());
                        const w = parseInt(val.split("ë…„")[1].replace("ì£¼ì°¨", "").trim());

                        const start = getDateOfISOWeek(w, y);
                        const end = new Date(start);
                        end.setDate(start.getDate() + 6);

                        $stdate.val(formatDate(start)).prop('readOnly', true);
                        $eddate.val(formatDate(end)).prop('readOnly', true);
                    });

                    $extraSelectBox.append($weekSelect);
                    $weekSelect.trigger('change'); // âœ… í˜„ì¬ ì„ íƒëœ ì£¼ì°¨ë¡œ stdate/eddate ì„¸íŒ…

                } else if (type === 'month') {
                    const $monthSelect = $('<select id="popupMonthSelector"></select>');

                    const year = targetDate.getFullYear();
                    const selectedMonth = targetDate.getMonth() + 1;

                    for (let i = 1; i <= 12; i++) {
                        const value = `${year}-${String(i).padStart(2, "0")}`;
                        const text = `${year}ë…„ ${i}ì›”`;
                        const $option = $(`<option value="${value}">${text}</option>`);
                        if (i === selectedMonth) {
                            $option.prop("selected", true);
                        }
                        $monthSelect.append($option);
                    }

                    $monthSelect.on('change', function () {
                        const [y, m] = $(this).val().split('-');
                        const start = new Date(parseInt(y), parseInt(m) - 1, 1);
                        const end = new Date(parseInt(y), parseInt(m), 0);
                        $stdate.val(formatDate(start)).prop('readOnly', true);
                        $eddate.val(formatDate(end)).prop('readOnly', true);
                    });

                    $extraSelectBox.append($monthSelect);
                    $monthSelect.trigger('change');

                } else {
                    // ê¸°ë³¸: ìµœê·¼ 7ì¼
                    const startVal = CommonUtil.getYYYYMMDD(-7);
                    const endVal = CommonUtil.getYYYYMMDD();
                    $stdate.val(startVal).prop('readOnly', false);
                    $eddate.val(endVal).prop('readOnly', false);
                }
            });

            // ìµœì´ˆ ì ìš©
            $datetype.trigger('change');
        }


        // ISO ì£¼ì°¨ ê³„ì‚°
        function getDateOfISOWeek(week, year) {
            const jan4 = new Date(year, 0, 4);
            const day = jan4.getDay() || 7;
            const start = new Date(jan4);
            start.setDate(jan4.getDate() - day + 1 + (week - 1) * 7);
            return start;
        }

        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, "0");
            const d = String(date.getDate()).padStart(2, "0");
            return `${y}-${m}-${d}`;
        }

        function getISOWeekNumber(date) {
            const target = new Date(date.valueOf());
            const dayNum = (date.getDay() + 6) % 7;
            target.setDate(target.getDate() - dayNum + 3);
            const firstThursday = new Date(target.getFullYear(), 0, 4);
            const diff = target - firstThursday;
            return 1 + Math.round(diff / (7 * 24 * 60 * 60 * 1000));
        }

        function parseDate(str) {
            if (!str) return new Date();
            if (/^\d{8}$/.test(str)) {
                return new Date(
                    parseInt(str.slice(0, 4)),
                    parseInt(str.slice(4, 6)) - 1,
                    parseInt(str.slice(6, 8))
                );
            } else if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
                return new Date(str);
            }
            return new Date();
        }

        let page = null;

        $(document).ready(function (e) {

            page = new WorkReportPage();

            $('#srchStartDt').val(CommonUtil.getYYYYMMDD(-7));
            $('#srchEndDt').val(CommonUtil.getYYYYMMDD());

            page.searchMainData();


            // ê²€ìƒ‰
            $('#btnSearch').click(function (e) {
                page.searchMainData();
            });


        })

        document.addEventListener("DOMContentLoaded", function () {
            const cboDateKind = document.getElementById("cboDateKind");
            const extraSelectBox = document.getElementById("extraSelectBox");
            const srchStartDt = document.getElementById("srchStartDt");
            const srchEndDt = document.getElementById("srchEndDt");

            cboDateKind.addEventListener("change", function () {
                const type = this.value;

                extraSelectBox.innerHTML = ""; // ì´ˆê¸°í™”
                srchStartDt.value = "";
                srchEndDt.value = "";
                srchStartDt.readOnly = false;
                srchEndDt.readOnly = false;

                if (type === "week") {
                    const select = document.createElement("select");
                    select.id = "weekSelector";

                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const currentWeek = getISOWeekNumber(now);
                    for (let i = 1; i <= 52; i++) {
                        const option = document.createElement("option");
                        option.value = `${currentYear}ë…„ ${i}ì£¼ì°¨`;
                        option.textContent = `${currentYear}ë…„ ${i}ì£¼ì°¨`;
                        if (i === currentWeek) {
                            option.selected = true; // â† í˜„ì¬ ì£¼ì°¨ ìë™ ì„ íƒ
                        }
                        select.appendChild(option);
                    }

                    select.addEventListener("change", function () {
                        const weekText = this.value; // ì˜ˆ: "2025ë…„ 11ì£¼ì°¨"

                        // ğŸ”¥ í•œêµ­ì–´ ë¬¸ìì—´ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ
                        const year = parseInt(weekText.split("ë…„")[0].trim());
                        const weekNum = parseInt(
                            weekText.split("ë…„")[1].replace("ì£¼ì°¨", "").trim()
                        );

                        const start = getDateOfISOWeek(weekNum, year);
                        const end = new Date(start);
                        end.setDate(start.getDate() + 6);

                        srchStartDt.value = formatDate(start);
                        srchEndDt.value = formatDate(end);

                        srchStartDt.readOnly = true;
                        srchEndDt.readOnly = true;
                    });

                    extraSelectBox.appendChild(select);
                    select.dispatchEvent(new Event("change")); // ì´ˆê¸° ì„ íƒê°’ ë°˜ì˜
                } else if (type === "month") {
                    const select = document.createElement("select");
                    select.id = "monthSelector";

                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const currentMonth = now.getMonth();

                    for (let i = 0; i < 12; i++) {
                        const month = new Date(currentYear, i, 1);
                        const option = document.createElement("option");
                        option.value = `${month.getFullYear()}-${String(month.getMonth() + 1).padStart(2, "0")}`;
                        option.textContent = `${month.getFullYear()}ë…„ ${month.getMonth() + 1}ì›”`;
                        if (i === currentMonth) {
                            option.selected = true; // â† í˜„ì¬ ë‹¬ ìë™ ì„ íƒ
                        }
                        select.appendChild(option);
                    }

                    select.selectedIndex = currentMonth;

                    select.addEventListener("change", function () {
                        const [year, month] = this.value.split("-");
                        const start = new Date(parseInt(year), parseInt(month) - 1, 1);
                        const end = new Date(parseInt(year), parseInt(month), 0); // ë§ì¼

                        srchStartDt.value = formatDate(start);
                        srchEndDt.value = formatDate(end);
                        srchStartDt.readOnly = true;
                        srchEndDt.readOnly = true;
                    });

                    extraSelectBox.appendChild(select);
                    select.dispatchEvent(new Event("change")); // ì´ˆê¸° ì„ íƒê°’ ë°˜ì˜
                } else {
                    const startVal = CommonUtil.getYYYYMMDD(-7);
                    const endVal = CommonUtil.getYYYYMMDD();

                    $('#srchStartDt').val(startVal).prop('readOnly', false);
                    $('#srchEndDt').val(endVal).prop('readOnly', false);
                }
            });

            function getDateOfISOWeek(week, year) {
                const jan4 = new Date(year, 0, 4); // í•­ìƒ 1ì›” 4ì¼ ê¸°ì¤€
                const day = jan4.getDay() || 7;
                const start = new Date(jan4);
                start.setDate(jan4.getDate() - day + 1 + (week - 1) * 7);
                return start;
            }

            function formatDate(date) {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, "0");
                const d = String(date.getDate()).padStart(2, "0");
                return `${y}-${m}-${d}`;
            }

            function getISOWeekNumber(date) {
                const target = new Date(date.valueOf());
                const dayNum = (date.getDay() + 6) % 7;
                target.setDate(target.getDate() - dayNum + 3);
                const firstThursday = new Date(target.getFullYear(), 0, 4);
                const diff = target - firstThursday;
                return 1 + Math.round(diff / (7 * 24 * 60 * 60 * 1000));
            }
        });


    </script>

</th:block>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>